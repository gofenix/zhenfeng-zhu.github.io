<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Lsp Intro | Awesome Fenix</title><meta name=keywords content><meta name=description content="为什么是语言服务器 语言服务器是一种特殊的 Visual Studio Code 扩展，为许多编程语言的编辑体验提供动力。通过语言服务器，你可以实现自动完成、错误检查（诊断）、跳转到定义，以及 VS Code 中支持的许多其他语言功能。
然而，在实现对 VS Code 中语言功能的支持时，我们发现了三个常见的问题:
首先，语言服务器通常是用他们的本地编程语言实现的，这给他们与具有 Node.js 运行时间的 VS Code 集成带来了挑战。
此外，语言功能可能是资源密集型的。例如，为了正确验证一个文件，语言服务器需要解析大量的文件，为它们建立抽象语法树并进行静态程序分析。这些操作可能会产生大量的 CPU 和内存占用，我们需要确保 VS Code 的性能不受影响。
最后，将多种语言工具与多种代码编辑器整合在一起，可能会涉及大量的工作。从语言工具的角度来看，他们需要适应具有不同 API 的代码编辑器。从代码编辑器的角度来看，他们不能期望从语言工具中获得任何统一的 API。这使得在 N 个代码编辑器中实现对 M 种语言的语言支持成为 M*N 的工作。
为了解决这些问题，微软制定了语言服务器协议，它使语言工具和代码编辑器之间的通信标准化。这样，语言服务器可以用任何语言实现，并在自己的进程中运行，以避免性能成本，因为它们通过语言服务器协议与代码编辑器通信。此外，任何符合 LSP 的语言工具都可以与多个符合 LSP 的代码编辑器集成，任何符合 LSP 的代码编辑器都可以轻易地接上多个符合 LSP 的语言工具。LSP 对于语言工具供应商和代码编辑器供应商来说都是一种共赢。
实现一个语言服务器 概述 在 VS Code 中，一个语言服务器有两个部分：
 语言客户端。一个用 JavaScript/TypeScript 编写的普通 VS Code 扩展。这个扩展可以访问所有 VS Code 的命名空间 API。 语言服务器。一个在独立进程中运行的语言分析工具。  如上所述，在一个单独的进程中运行语言服务器有两个好处：
 分析工具可以用任何语言实现，只要它能按照语言服务器协议与语言客户端通信。 由于语言分析工具通常对 CPU 和内存的使用率很高，在单独的进程中运行它们可以避免性能成本。  下面是一个 VS Code 运行两个语言服务器扩展的例子："><meta name=author content="Fenix"><link rel=canonical href=https://zhenfeng-zhu.github.io/post/lsp-intro/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://zhenfeng-zhu.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zhenfeng-zhu.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://zhenfeng-zhu.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://zhenfeng-zhu.github.io/apple-touch-icon.png><link rel=mask-icon href=https://zhenfeng-zhu.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.98.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-216295420-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Lsp Intro"><meta property="og:description" content="为什么是语言服务器 语言服务器是一种特殊的 Visual Studio Code 扩展，为许多编程语言的编辑体验提供动力。通过语言服务器，你可以实现自动完成、错误检查（诊断）、跳转到定义，以及 VS Code 中支持的许多其他语言功能。
然而，在实现对 VS Code 中语言功能的支持时，我们发现了三个常见的问题:
首先，语言服务器通常是用他们的本地编程语言实现的，这给他们与具有 Node.js 运行时间的 VS Code 集成带来了挑战。
此外，语言功能可能是资源密集型的。例如，为了正确验证一个文件，语言服务器需要解析大量的文件，为它们建立抽象语法树并进行静态程序分析。这些操作可能会产生大量的 CPU 和内存占用，我们需要确保 VS Code 的性能不受影响。
最后，将多种语言工具与多种代码编辑器整合在一起，可能会涉及大量的工作。从语言工具的角度来看，他们需要适应具有不同 API 的代码编辑器。从代码编辑器的角度来看，他们不能期望从语言工具中获得任何统一的 API。这使得在 N 个代码编辑器中实现对 M 种语言的语言支持成为 M*N 的工作。
为了解决这些问题，微软制定了语言服务器协议，它使语言工具和代码编辑器之间的通信标准化。这样，语言服务器可以用任何语言实现，并在自己的进程中运行，以避免性能成本，因为它们通过语言服务器协议与代码编辑器通信。此外，任何符合 LSP 的语言工具都可以与多个符合 LSP 的代码编辑器集成，任何符合 LSP 的代码编辑器都可以轻易地接上多个符合 LSP 的语言工具。LSP 对于语言工具供应商和代码编辑器供应商来说都是一种共赢。
实现一个语言服务器 概述 在 VS Code 中，一个语言服务器有两个部分：
 语言客户端。一个用 JavaScript/TypeScript 编写的普通 VS Code 扩展。这个扩展可以访问所有 VS Code 的命名空间 API。 语言服务器。一个在独立进程中运行的语言分析工具。  如上所述，在一个单独的进程中运行语言服务器有两个好处：
 分析工具可以用任何语言实现，只要它能按照语言服务器协议与语言客户端通信。 由于语言分析工具通常对 CPU 和内存的使用率很高，在单独的进程中运行它们可以避免性能成本。  下面是一个 VS Code 运行两个语言服务器扩展的例子："><meta property="og:type" content="article"><meta property="og:url" content="https://zhenfeng-zhu.github.io/post/lsp-intro/"><meta property="og:image" content="https://zhenfeng-zhu.github.io/papermod-cover.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-04-30T18:53:11+08:00"><meta property="article:modified_time" content="2022-04-30T18:53:11+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zhenfeng-zhu.github.io/papermod-cover.png"><meta name=twitter:title content="Lsp Intro"><meta name=twitter:description content="为什么是语言服务器 语言服务器是一种特殊的 Visual Studio Code 扩展，为许多编程语言的编辑体验提供动力。通过语言服务器，你可以实现自动完成、错误检查（诊断）、跳转到定义，以及 VS Code 中支持的许多其他语言功能。
然而，在实现对 VS Code 中语言功能的支持时，我们发现了三个常见的问题:
首先，语言服务器通常是用他们的本地编程语言实现的，这给他们与具有 Node.js 运行时间的 VS Code 集成带来了挑战。
此外，语言功能可能是资源密集型的。例如，为了正确验证一个文件，语言服务器需要解析大量的文件，为它们建立抽象语法树并进行静态程序分析。这些操作可能会产生大量的 CPU 和内存占用，我们需要确保 VS Code 的性能不受影响。
最后，将多种语言工具与多种代码编辑器整合在一起，可能会涉及大量的工作。从语言工具的角度来看，他们需要适应具有不同 API 的代码编辑器。从代码编辑器的角度来看，他们不能期望从语言工具中获得任何统一的 API。这使得在 N 个代码编辑器中实现对 M 种语言的语言支持成为 M*N 的工作。
为了解决这些问题，微软制定了语言服务器协议，它使语言工具和代码编辑器之间的通信标准化。这样，语言服务器可以用任何语言实现，并在自己的进程中运行，以避免性能成本，因为它们通过语言服务器协议与代码编辑器通信。此外，任何符合 LSP 的语言工具都可以与多个符合 LSP 的代码编辑器集成，任何符合 LSP 的代码编辑器都可以轻易地接上多个符合 LSP 的语言工具。LSP 对于语言工具供应商和代码编辑器供应商来说都是一种共赢。
实现一个语言服务器 概述 在 VS Code 中，一个语言服务器有两个部分：
 语言客户端。一个用 JavaScript/TypeScript 编写的普通 VS Code 扩展。这个扩展可以访问所有 VS Code 的命名空间 API。 语言服务器。一个在独立进程中运行的语言分析工具。  如上所述，在一个单独的进程中运行语言服务器有两个好处：
 分析工具可以用任何语言实现，只要它能按照语言服务器协议与语言客户端通信。 由于语言分析工具通常对 CPU 和内存的使用率很高，在单独的进程中运行它们可以避免性能成本。  下面是一个 VS Code 运行两个语言服务器扩展的例子："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://zhenfeng-zhu.github.io/post/"},{"@type":"ListItem","position":3,"name":"Lsp Intro","item":"https://zhenfeng-zhu.github.io/post/lsp-intro/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Lsp Intro","name":"Lsp Intro","description":"为什么是语言服务器 语言服务器是一种特殊的 Visual Studio Code 扩展，为许多编程语言的编辑体验提供动力。通过语言服务器，你可以实现自动完成、错误检查（诊断）、跳转到定义，以及 VS Code 中支持的许多其他语言功能。\n然而，在实现对 VS Code 中语言功能的支持时，我们发现了三个常见的问题:\n首先，语言服务器通常是用他们的本地编程语言实现的，这给他们与具有 Node.js 运行时间的 VS Code 集成带来了挑战。\n此外，语言功能可能是资源密集型的。例如，为了正确验证一个文件，语言服务器需要解析大量的文件，为它们建立抽象语法树并进行静态程序分析。这些操作可能会产生大量的 CPU 和内存占用，我们需要确保 VS Code 的性能不受影响。\n最后，将多种语言工具与多种代码编辑器整合在一起，可能会涉及大量的工作。从语言工具的角度来看，他们需要适应具有不同 API 的代码编辑器。从代码编辑器的角度来看，他们不能期望从语言工具中获得任何统一的 API。这使得在 N 个代码编辑器中实现对 M 种语言的语言支持成为 M*N 的工作。\n为了解决这些问题，微软制定了语言服务器协议，它使语言工具和代码编辑器之间的通信标准化。这样，语言服务器可以用任何语言实现，并在自己的进程中运行，以避免性能成本，因为它们通过语言服务器协议与代码编辑器通信。此外，任何符合 LSP 的语言工具都可以与多个符合 LSP 的代码编辑器集成，任何符合 LSP 的代码编辑器都可以轻易地接上多个符合 LSP 的语言工具。LSP 对于语言工具供应商和代码编辑器供应商来说都是一种共赢。\n实现一个语言服务器 概述 在 VS Code 中，一个语言服务器有两个部分：\n 语言客户端。一个用 JavaScript/TypeScript 编写的普通 VS Code 扩展。这个扩展可以访问所有 VS Code 的命名空间 API。 语言服务器。一个在独立进程中运行的语言分析工具。  如上所述，在一个单独的进程中运行语言服务器有两个好处：\n 分析工具可以用任何语言实现，只要它能按照语言服务器协议与语言客户端通信。 由于语言分析工具通常对 CPU 和内存的使用率很高，在单独的进程中运行它们可以避免性能成本。  下面是一个 VS Code 运行两个语言服务器扩展的例子：","keywords":[""],"articleBody":"为什么是语言服务器 语言服务器是一种特殊的 Visual Studio Code 扩展，为许多编程语言的编辑体验提供动力。通过语言服务器，你可以实现自动完成、错误检查（诊断）、跳转到定义，以及 VS Code 中支持的许多其他语言功能。\n然而，在实现对 VS Code 中语言功能的支持时，我们发现了三个常见的问题:\n首先，语言服务器通常是用他们的本地编程语言实现的，这给他们与具有 Node.js 运行时间的 VS Code 集成带来了挑战。\n此外，语言功能可能是资源密集型的。例如，为了正确验证一个文件，语言服务器需要解析大量的文件，为它们建立抽象语法树并进行静态程序分析。这些操作可能会产生大量的 CPU 和内存占用，我们需要确保 VS Code 的性能不受影响。\n最后，将多种语言工具与多种代码编辑器整合在一起，可能会涉及大量的工作。从语言工具的角度来看，他们需要适应具有不同 API 的代码编辑器。从代码编辑器的角度来看，他们不能期望从语言工具中获得任何统一的 API。这使得在 N 个代码编辑器中实现对 M 种语言的语言支持成为 M*N 的工作。\n为了解决这些问题，微软制定了语言服务器协议，它使语言工具和代码编辑器之间的通信标准化。这样，语言服务器可以用任何语言实现，并在自己的进程中运行，以避免性能成本，因为它们通过语言服务器协议与代码编辑器通信。此外，任何符合 LSP 的语言工具都可以与多个符合 LSP 的代码编辑器集成，任何符合 LSP 的代码编辑器都可以轻易地接上多个符合 LSP 的语言工具。LSP 对于语言工具供应商和代码编辑器供应商来说都是一种共赢。\n实现一个语言服务器 概述 在 VS Code 中，一个语言服务器有两个部分：\n 语言客户端。一个用 JavaScript/TypeScript 编写的普通 VS Code 扩展。这个扩展可以访问所有 VS Code 的命名空间 API。 语言服务器。一个在独立进程中运行的语言分析工具。  如上所述，在一个单独的进程中运行语言服务器有两个好处：\n 分析工具可以用任何语言实现，只要它能按照语言服务器协议与语言客户端通信。 由于语言分析工具通常对 CPU 和内存的使用率很高，在单独的进程中运行它们可以避免性能成本。  下面是一个 VS Code 运行两个语言服务器扩展的例子：\nHTML 语言客户端和 PHP 语言客户端是用 TypeScript 编写的普通 VS Code 扩展。它们中的每一个都实例化了一个相应的语言服务器，并通过 LSP 与它们进行通信。虽然 PHP 语言服务器是用 PHP 编写的，但它仍然可以通过 LSP 与 PHP 语言客户端进行通信。\n本指南将教你如何使用我们的 Node SDK 建立一个语言客户端/服务器。其余的文件假定你熟悉 VS Code Extension API。\nLSP 样例 - 一个简单的纯文本文件的语言服务器 让我们建立一个简单的语言服务器扩展，为纯文本文件实现自动完成和诊断功能。我们还将涵盖客户端/服务器之间的配置同步。\n如果你喜欢直接跳到代码中：\n lsp-sample 本指南有大量的源代码。 lsp-multi-server-sample，lsp-sample 的高级版本，它为每个工作区文件夹启动一个不同的服务器实例，以支持 VS Code 中的多根工作区功能。  克隆存储库 Microsoft/vscode-extension-samples 并打开样例：\n1 2 3 4 5   git clone https://github.com/microsoft/vscode-extension-samples.git  cd vscode-extension-samples/lsp-sample  npm install  npm run compile  code .   以上安装了所有的依赖项，并打开了包含客户端和服务器代码的 lsp-sample 工作区。下面是 lsp-sample 结构的一个粗略概述:\n1 2 3 4 5 6 7 8 9  . ├── client // Language Client │ ├── src │ │ ├── test // End to End tests for Language Client / Server │ │ └── extension.ts // Language Client entry point ├── package.json // The extension manifest └── server // Language Server  └── src  └── server.ts // Language Server entry point   详解 “语言客户端\" 我们先来看看/package.json，它描述了语言客户端的能力。这里有三个有趣的部分。\n首先看激活事件（activationEvents）:\n1 2 3  \"activationEvents\": [  \"onLanguage:plaintext\" ]   这一部分告诉 VS Code，一旦打开纯文本文件（例如扩展名为.txt 的文件），就立即激活扩展。\n接下来看看配置部分:\n1 2 3 4 5 6 7 8 9 10 11 12  \"configuration\": {  \"type\": \"object\",  \"title\": \"Example configuration\",  \"properties\": {  \"languageServerExample.maxNumberOfProblems\": {  \"scope\": \"resource\",  \"type\": \"number\",  \"default\": 100,  \"description\": \"Controls the maximum number of problems produced by the server.\"  }  } }   本节为 VS Code 提供了配置设置。这个例子将解释这些设置是如何在启动时和每次改变设置时发送到语言服务器上的。\n实际的语言客户端源代码和相应的 package.json 在/client 文件夹中。\n/client/package.json 文件中有趣的部分是，它通过引擎字段引用了 vscode 扩展主机 API，并添加了对 vscode-languageclient 库的依赖:\n1 2 3 4 5 6  \"engines\": {  \"vscode\": \"^1.52.0\" }, \"dependencies\": {  \"vscode-languageclient\": \"^7.0.0\" }   如前所述，客户端被实现为一个普通的 VS Code 扩展，它可以访问所有 VS Code 命名空间的 API。\n下面是相应的 extension.ts 文件的内容，它是 lsp-sample 完整代码:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57  import * as path from 'path'; import { workspace, ExtensionContext } from 'vscode';  import {  LanguageClient,  LanguageClientOptions,  ServerOptions,  TransportKind } from 'vscode-languageclient/node';  let client: LanguageClient;  export function activate(context: ExtensionContext) {  // The server is implemented in node  let serverModule = context.asAbsolutePath(path.join('server', 'out', 'server.js'));  // The debug options for the server  // --inspect=6009: runs the server in Node's Inspector mode so VS Code can attach to the server for debugging  let debugOptions = { execArgv: ['--nolazy', '--inspect=6009'] };   // If the extension is launched in debug mode then the debug server options are used  // Otherwise the run options are used  let serverOptions: ServerOptions = {  run: { module: serverModule, transport: TransportKind.ipc },  debug: {  module: serverModule,  transport: TransportKind.ipc,  options: debugOptions  }  };   // Options to control the language client  let clientOptions: LanguageClientOptions = {  // Register the server for plain text documents  documentSelector: [{ scheme: 'file', language: 'plaintext' }],  synchronize: {  // Notify the server about file changes to '.clientrc files contained in the workspace  fileEvents: workspace.createFileSystemWatcher('**/.clientrc')  }  };   // Create the language client and start the client.  client = new LanguageClient(  'languageServerExample',  'Language Server Example',  serverOptions,  clientOptions  );   // Start the client. This will also launch the server  client.start(); }  export function deactivate(): Thenablevoid | undefined {  if (!client) {  return undefined;  }  return client.stop();   详解语言服务器 在这个例子中，服务器也是用 TypeScript 实现的，并使用 Node.js 执行。由于 VS Code 已经带有 Node.js 的运行时间，所以没有必要提供你自己的，除非你对运行时间有特殊要求。\n语言服务器的源代码在/server。在服务器的 package.json 文件中，有趣的部分是:\n1 2 3 4  \"dependencies\": {  \"vscode-languageserver\": \"^7.0.0\",  \"vscode-languageserver-textdocument\": \"^1.0.1\" }   这就引入了 vscode-languageserver 库。\n下面是一个服务器的实现，它使用了所提供的简单的文本文档管理器，通过总是将文件的完整内容从 VS Code 发送到服务器来同步文本文档:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224  import {  createConnection,  TextDocuments,  Diagnostic,  DiagnosticSeverity,  ProposedFeatures,  InitializeParams,  DidChangeConfigurationNotification,  CompletionItem,  CompletionItemKind,  TextDocumentPositionParams,  TextDocumentSyncKind,  InitializeResult } from 'vscode-languageserver/node';  import { TextDocument } from 'vscode-languageserver-textdocument';  // Create a connection for the server, using Node's IPC as a transport. // Also include all preview / proposed LSP features. let connection = createConnection(ProposedFeatures.all);  // Create a simple text document manager. let documents: TextDocumentsTextDocument = new TextDocuments(TextDocument);  let hasConfigurationCapability: boolean = false; let hasWorkspaceFolderCapability: boolean = false; let hasDiagnosticRelatedInformationCapability: boolean = false;  connection.onInitialize((params: InitializeParams) = {  let capabilities = params.capabilities;   // Does the client support the `workspace/configuration` request?  // If not, we fall back using global settings.  hasConfigurationCapability = !!(  capabilities.workspace \u0026\u0026 !!capabilities.workspace.configuration  );  hasWorkspaceFolderCapability = !!(  capabilities.workspace \u0026\u0026 !!capabilities.workspace.workspaceFolders  );  hasDiagnosticRelatedInformationCapability = !!(  capabilities.textDocument \u0026\u0026  capabilities.textDocument.publishDiagnostics \u0026\u0026  capabilities.textDocument.publishDiagnostics.relatedInformation  );   const result: InitializeResult = {  capabilities: {  textDocumentSync: TextDocumentSyncKind.Incremental,  // Tell the client that this server supports code completion.  completionProvider: {  resolveProvider: true  }  }  };  if (hasWorkspaceFolderCapability) {  result.capabilities.workspace = {  workspaceFolders: {  supported: true  }  };  }  return result; });  connection.onInitialized(() = {  if (hasConfigurationCapability) {  // Register for all configuration changes.  connection.client.register(DidChangeConfigurationNotification.type, undefined);  }  if (hasWorkspaceFolderCapability) {  connection.workspace.onDidChangeWorkspaceFolders(_event = {  connection.console.log('Workspace folder change event received.');  });  } });  // The example settings interface ExampleSettings {  maxNumberOfProblems: number; }  // The global settings, used when the `workspace/configuration` request is not supported by the client. // Please note that this is not the case when using this server with the client provided in this example // but could happen with other clients. const defaultSettings: ExampleSettings = { maxNumberOfProblems: 1000 }; let globalSettings: ExampleSettings = defaultSettings;  // Cache the settings of all open documents let documentSettings: Mapstring, ThenableExampleSettings = new Map();  connection.onDidChangeConfiguration(change = {  if (hasConfigurationCapability) {  // Reset all cached document settings  documentSettings.clear();  } else {  globalSettings = ExampleSettings(  (change.settings.languageServerExample || defaultSettings)  );  }   // Revalidate all open text documents  documents.all().forEach(validateTextDocument); });  function getDocumentSettings(resource: string): ThenableExampleSettings {  if (!hasConfigurationCapability) {  return Promise.resolve(globalSettings);  }  let result = documentSettings.get(resource);  if (!result) {  result = connection.workspace.getConfiguration({  scopeUri: resource,  section: 'languageServerExample'  });  documentSettings.set(resource, result);  }  return result; }  // Only keep settings for open documents documents.onDidClose(e = {  documentSettings.delete(e.document.uri); });  // The content of a text document has changed. This event is emitted // when the text document first opened or when its content has changed. documents.onDidChangeContent(change = {  validateTextDocument(change.document); });  async function validateTextDocument(textDocument: TextDocument): Promisevoid {  // In this simple example we get the settings for every validate run.  let settings = await getDocumentSettings(textDocument.uri);   // The validator creates diagnostics for all uppercase words length 2 and more  let text = textDocument.getText();  let pattern = /\\b[A-Z]{2,}\\b/g;  let m: RegExpExecArray | null;   let problems = 0;  let diagnostics: Diagnostic[] = [];  while ((m = pattern.exec(text)) \u0026\u0026 problems  settings.maxNumberOfProblems) {  problems++;  let diagnostic: Diagnostic = {  severity: DiagnosticSeverity.Warning,  range: {  start: textDocument.positionAt(m.index),  end: textDocument.positionAt(m.index + m[0].length)  },  message: `${m[0]}is all uppercase.`,  source: 'ex'  };  if (hasDiagnosticRelatedInformationCapability) {  diagnostic.relatedInformation = [  {  location: {  uri: textDocument.uri,  range: Object.assign({}, diagnostic.range)  },  message: 'Spelling matters'  },  {  location: {  uri: textDocument.uri,  range: Object.assign({}, diagnostic.range)  },  message: 'Particularly for names'  }  ];  }  diagnostics.push(diagnostic);  }   // Send the computed diagnostics to VS Code.  connection.sendDiagnostics({ uri: textDocument.uri, diagnostics }); }  connection.onDidChangeWatchedFiles(_change = {  // Monitored files have change in VS Code  connection.console.log('We received a file change event'); });  // This handler provides the initial list of the completion items. connection.onCompletion(  (_textDocumentPosition: TextDocumentPositionParams): CompletionItem[] = {  // The pass parameter contains the position of the text document in  // which code complete got requested. For the example we ignore this  // info and always provide the same completion items.  return [  {  label: 'TypeScript',  kind: CompletionItemKind.Text,  data: 1  },  {  label: 'JavaScript',  kind: CompletionItemKind.Text,  data: 2  }  ];  } );  // This handler resolves additional information for the item selected in // the completion list. connection.onCompletionResolve(  (item: CompletionItem): CompletionItem = {  if (item.data === 1) {  item.detail = 'TypeScript details';  item.documentation = 'TypeScript documentation';  } else if (item.data === 2) {  item.detail = 'JavaScript details';  item.documentation = 'JavaScript documentation';  }  return item;  } );  // Make the text document manager listen on the connection // for open, change and close text document events documents.listen(connection);  // Listen on the connection connection.listen();   添加一个简单的验证功能 为了给服务器添加文档验证，我们给文本文档管理器添加了一个监听器，每当文本文档的内容发生变化时就会被调用。然后由服务器来决定何时是验证文档的最佳时机。在这个例子的实现中，服务器验证纯文本文档，并标记所有使用大写字母的单词的出现。相应的代码片段看起来像这样:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  // The content of a text document has changed. This event is emitted // when the text document first opened or when its content has changed. documents.onDidChangeContent(async change = {  let textDocument = change.document;  // In this simple example we get the settings for every validate run.  let settings = await getDocumentSettings(textDocument.uri);   // The validator creates diagnostics for all uppercase words length 2 and more  let text = textDocument.getText();  let pattern = /\\b[A-Z]{2,}\\b/g;  let m: RegExpExecArray | null;   let problems = 0;  let diagnostics: Diagnostic[] = [];  while ((m = pattern.exec(text)) \u0026\u0026 problems  settings.maxNumberOfProblems) {  problems++;  let diagnostic: Diagnostic = {  severity: DiagnosticSeverity.Warning,  range: {  start: textDocument.positionAt(m.index),  end: textDocument.positionAt(m.index + m[0].length)  },  message: `${m[0]}is all uppercase.`,  source: 'ex'  };  if (hasDiagnosticRelatedInformationCapability) {  diagnostic.relatedInformation = [  {  location: {  uri: textDocument.uri,  range: Object.assign({}, diagnostic.range)  },  message: 'Spelling matters'  },  {  location: {  uri: textDocument.uri,  range: Object.assign({}, diagnostic.range)  },  message: 'Particularly for names'  }  ];  }  diagnostics.push(diagnostic);  }   // Send the computed diagnostics to VS Code.  connection.sendDiagnostics({ uri: textDocument.uri, diagnostics }); });   诊断技巧和窍门 如果开始和结束的位置相同，VS Code 将在该位置用斜线划出单词。 如果你想用斜线划线，直到行的末尾，那么将末尾位置的字符设置为 Number.MAX_VALUE。 要运行语言服务器，请执行以下步骤。\n按⇧ ⌘B 启动构建任务。这个任务会同时编译客户端和服务器。 打开运行视图，选择 Launch Client 启动配置，按 Start Debugging 按钮，启动一个额外的 VS Code 的扩展开发主机实例，执行扩展代码。 在根目录下创建一个 test.txt 文件，粘贴以下内容:\n1 2 3  TypeScript lets you write JavaScript the way you really want to. TypeScript is a typed superset of JavaScript that compiles to plain JavaScript. ANY browser. ANY host. ANY OS. Open Source.   然后，扩展开发主机实例将看起来像这样:\n同时调试客户端和服务器 调试客户端代码和调试普通扩展一样简单。在客户端代码中设置一个断点，按 F5 键调试扩展。\n由于服务器是由在扩展程序（客户端）中运行的 LanguageClient 启动的，我们需要将调试器附加到运行的服务器上。要做到这一点，请切换到运行视图，选择启动配置 Attach to Server 并按 F5。这将把调试器附加到服务器上。\n语言服务器的日志支持 如果你使用 vscode-languageclient 来实现客户端，你可以指定一个设置[langId].trace.server，指示客户端将语言客户端/服务器之间的通信记录到语言客户端名称的通道中。\n对于 lsp-sample，你可以配置这个设置。\"languageServerExample.trace.server\": \"verbose\"。现在前往 “语言服务器示例 “频道。你应该看到日志:\n使用服务器中的配置 在编写扩展的客户端部分时，我们已经定义了一个设置来控制报告问题的最大数量。我们还在服务器端写了代码，从客户端读取这些设置。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  function getDocumentSettings(resource: string): ThenableExampleSettings {  if (!hasConfigurationCapability) {  return Promise.resolve(globalSettings);  }  let result = documentSettings.get(resource);  if (!result) {  result = connection.workspace.getConfiguration({  scopeUri: resource,  section: 'languageServerExample'  });  documentSettings.set(resource, result);  }  return result; }   我们现在唯一需要做的是监听服务器端的配置变化，如果设置发生变化，就重新验证打开的文本文档。为了能够重复使用文档变化事件处理的验证逻辑，我们将代码提取到 validateTextDocument 函数中，并修改代码以尊重 maxNumberOfProblems 变量:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  async function validateTextDocument(textDocument: TextDocument): Promisevoid {  // In this simple example we get the settings for every validate run.  let settings = await getDocumentSettings(textDocument.uri);   // The validator creates diagnostics for all uppercase words length 2 and more  let text = textDocument.getText();  let pattern = /\\b[A-Z]{2,}\\b/g;  let m: RegExpExecArray | null;   let problems = 0;  let diagnostics: Diagnostic[] = [];  while ((m = pattern.exec(text)) \u0026\u0026 problems  settings.maxNumberOfProblems) {  problems++;  let diagnostic: Diagnostic = {  severity: DiagnosticSeverity.Warning,  range: {  start: textDocument.positionAt(m.index),  end: textDocument.positionAt(m.index + m[0].length)  },  message: `${m[0]}is all uppercase.`,  source: 'ex'  };  if (hasDiagnosticRelatedInformationCapability) {  diagnostic.relatedInformation = [  {  location: {  uri: textDocument.uri,  range: Object.assign({}, diagnostic.range)  },  message: 'Spelling matters'  },  {  location: {  uri: textDocument.uri,  range: Object.assign({}, diagnostic.range)  },  message: 'Particularly for names'  }  ];  }  diagnostics.push(diagnostic);  }   // Send the computed diagnostics to VS Code.  connection.sendDiagnostics({ uri: textDocument.uri, diagnostics }); }   对配置变化的处理是通过在连接中添加一个配置变化的通知处理程序来完成的。相应的代码看起来像这样:\n1 2 3 4 5 6 7 8 9 10 11 12 13  connection.onDidChangeConfiguration(change = {  if (hasConfigurationCapability) {  // Reset all cached document settings  documentSettings.clear();  } else {  globalSettings = ExampleSettings(  (change.settings.languageServerExample || defaultSettings)  );  }   // Revalidate all open text documents  documents.all().forEach(validateTextDocument); });   再次启动客户端，并将设置改为最大报告 1 个问题，结果出现以下验证:\n添加额外的语言功能 语言服务器通常实现的第一个有趣的功能是文件的验证。在这个意义上，即使是 linter 也算作一个语言服务器，在 VS Code 中，linter 通常被实现为语言服务器（见 eslint 和 jshint 的例子）。但语言服务器还有更多的作用。它们可以提供代码补全、查找所有引用、或转到定义。下面的示例代码将代码补全添加到服务器中。它提出了 “TypeScript “和 “JavaScript “两个词。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  // This handler provides the initial list of the completion items. connection.onCompletion(  (_textDocumentPosition: TextDocumentPositionParams): CompletionItem[] = {  // The pass parameter contains the position of the text document in  // which code complete got requested. For the example we ignore this  // info and always provide the same completion items.  return [  {  label: 'TypeScript',  kind: CompletionItemKind.Text,  data: 1  },  {  label: 'JavaScript',  kind: CompletionItemKind.Text,  data: 2  }  ];  } );  // This handler resolves additional information for the item selected in // the completion list. connection.onCompletionResolve(  (item: CompletionItem): CompletionItem = {  if (item.data === 1) {  item.detail = 'TypeScript details';  item.documentation = 'TypeScript documentation';  } else if (item.data === 2) {  item.detail = 'JavaScript details';  item.documentation = 'JavaScript documentation';  }  return item;  } );   数据字段被用来唯一地识别解析处理程序中的完成项目。数据属性对协议来说是透明的。因为底层的消息传递协议是基于 JSON 的，所以数据字段应该只持有可序列化为 JSON 的数据。\n所缺少的就是告诉 VS Code 服务器支持代码完成请求。要做到这一点，在初始化处理程序中标记相应的能力:\n1 2 3 4 5 6 7 8 9 10 11 12  connection.onInitialize((params): InitializeResult = {  ...  return {  capabilities: {  ...  // Tell the client that the server supports code completion  completionProvider: {  resolveProvider: true  }  }  }; });   下面的截图显示了在一个纯文本文件上运行的完整代码:\n测试语言服务器 为了创建一个高质量的语言服务器，我们需要建立一个涵盖其功能的良好测试套件。有两种常见的测试语言服务器的方法。\n  单元测试。如果你想通过模拟所有被发送到语言服务器的信息来测试语言服务器的特定功能，这很有用。VS Code 的 HTML / CSS / JSON 语言服务器采取这种测试方法。LSP 的 npm 模块也使用这种方法。请看这里，使用 npm 协议模块写的一些单元测试。\n  端到端测试。这类似于 VS Code 的扩展测试。这种方法的好处是，它通过实例化 VS Code 实例与工作区，打开文件，激活语言客户端/服务器，并运行 VS Code 命令来运行测试。如果你有很难或不可能模拟的文件、设置或依赖关系（如 node_modules），这种方法就很优越。流行的 Python 扩展就采用这种方法进行测试。\n  在你选择的任何测试框架中都有可能做单元测试。这里我们描述如何对语言服务器扩展做端到端的测试。\n打开.vscode/launch.json，你可以找到一个 E2E 测试目标:\n1 2 3 4 5 6 7 8 9 10 11 12  {  \"name\": \"Language Server E2E Test\",  \"type\": \"extensionHost\",  \"request\": \"launch\",  \"runtimeExecutable\": \"${execPath}\",  \"args\": [  \"--extensionDevelopmentPath=${workspaceRoot}\",  \"--extensionTestsPath=${workspaceRoot}/client/out/test/index\",  \"${workspaceRoot}/client/testFixture\"  ],  \"outFiles\": [\"${workspaceRoot}/client/out/test/**/*.js\"] }   如果你运行这个调试目标，它将启动一个 VS Code 实例，将 client/testFixture 作为活动工作空间。然后，VS Code 将继续执行客户端/src/test 中的所有测试。作为一个调试提示，你可以在客户端/src/test 中的 TypeScript 文件中设置断点，它们会被击中。\n让我们看一下 completion.test.ts 文件:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  import * as vscode from 'vscode'; import * as assert from 'assert'; import { getDocUri, activate } from './helper';  suite('Should do completion', () = {  const docUri = getDocUri('completion.txt');   test('Completes JS/TS in txt file', async () = {  await testCompletion(docUri, new vscode.Position(0, 0), {  items: [  { label: 'JavaScript', kind: vscode.CompletionItemKind.Text },  { label: 'TypeScript', kind: vscode.CompletionItemKind.Text }  ]  });  }); });  async function testCompletion(  docUri: vscode.Uri,  position: vscode.Position,  expectedCompletionList: vscode.CompletionList ) {  await activate(docUri);   // Executing the command `vscode.executeCompletionItemProvider` to simulate triggering completion  const actualCompletionList = (await vscode.commands.executeCommand(  'vscode.executeCompletionItemProvider',  docUri,  position  )) as vscode.CompletionList;   assert.ok(actualCompletionList.items.length = 2);  expectedCompletionList.items.forEach((expectedItem, i) = {  const actualItem = actualCompletionList.items[i];  assert.equal(actualItem.label, expectedItem.label);  assert.equal(actualItem.kind, expectedItem.kind);  }); }   在这个测试中，我们:\n  激活扩展。\n  运行命令 vscode.executeCompletionItemProvider，用一个 URI 和一个位置来模拟完成触发。\n  将返回的完成项目与我们预期的完成项目进行对比，进行断言。 让我们更深入地研究激活(docURI)函数。\n  它被定义在 client/src/test/helper.ts 中:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  import * as vscode from 'vscode'; import * as path from 'path';  export let doc: vscode.TextDocument; export let editor: vscode.TextEditor; export let documentEol: string; export let platformEol: string;  /** * Activates the vscode.lsp-sample extension */ export async function activate(docUri: vscode.Uri) {  // The extensionId is `publisher.name` from package.json  const ext = vscode.extensions.getExtension('vscode-samples.lsp-sample')!;  await ext.activate();  try {  doc = await vscode.workspace.openTextDocument(docUri);  editor = await vscode.window.showTextDocument(doc);  await sleep(2000); // Wait for server activation  } catch (e) {  console.error(e);  } }  async function sleep(ms: number) {  return new Promise(resolve = setTimeout(resolve, ms));   在激活的部分：\n  使用 package.json 中定义的{publisher.name}.{extensionId}获取扩展。\n  打开指定的文档，并在活动的文本编辑器中显示它。\n  睡眠 2 秒，这样我们就能确定语言服务器已经被实例化了。\n  准备工作完成后，我们可以运行与每个语言特性相对应的 VS 代码命令，并对返回的结果进行断言。\n还有一个测试，涵盖了我们刚刚实现的诊断功能。请看 client/src/test/diagnostics.test.ts。\n高级主题 到目前为止，本指南涵盖了。\n  语言服务器和语言服务器协议的简要概述。\n  VS 代码中的语言服务器扩展的架构\n  lsp-sample 扩展，以及如何开发/调试/检查/测试它。\n  有一些更高级的主题我们无法装入本指南中。我们将包括这些资源的链接，以便进一步研究语言服务器的开发。\n额外的语言服务器功能 目前在语言服务器中，与代码补全一起支持下列语言功能。\n 文档高亮：高亮显示一个文本文档中的所有 “相等 “符号。 悬停：为在文本文档中选择的符号提供悬停信息。 签名帮助：为文本文件中选定的符号提供签名帮助。 转到定义：为在文本文档中选择的符号提供转到定义的支持。 转到类型定义：为在文本文档中选择的符号提供转到类型/界面定义支持。 转到实现：为在文本文档中选择的符号提供转到实现定义的支持。 查找引用：为在文本文档中选择的符号查找所有项目范围内的引用。 List Document Symbols: 列出文本文档中定义的所有符号。 列出工作区符号：列出所有项目范围内的符号。 Code Actions：计算要对一个给定的文本文档和范围运行的命令（通常是美化/重构）。 CodeLens：为一个给定的文本文档计算 CodeLens 的统计数据。 文档格式化：这包括整个文档的格式化，文档范围和类型的格式化。 重命名：在项目范围内重命名一个符号。 文档链接：计算和解决一个文档内的链接。 文档颜色：计算和解析文档中的颜色，以便在编辑器中提供颜色选择器。  程序性语言功能主题描述了上述每个语言功能，并提供了如何通过语言服务器协议或直接从你的扩展中使用扩展性 API 来实现它们的指导。\n增量式文本文件同步 这个例子使用 vscode-languageserver 模块提供的简单文本文档管理器来同步 VS Code 和语言服务器之间的文档。\n这有两个缺点：\n 大量的数据被传输，因为整个文本文档的内容被重复地发送到服务器上。 如果使用现有的语言库，这种库通常支持增量的文档更新，以避免不必要的解析和抽象语法树的创建。  因此，该协议也支持增量文档同步。\n为了利用增量文档同步，服务器需要安装三个通知处理程序。\n onDidOpenTextDocument：当 VS Code 中打开一个文本文档时被调用。 onDidChangeTextDocument：当 VS Code 中的文本文档的内容发生变化时被调用。 onDidCloseTextDocument: 在 VS Code 中当一个文本文档被关闭时被调用。  下面是一个代码片段，说明了如何在一个连接上钩住这些通知处理程序，以及如何在初始化时返回正确的能力。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  connection.onInitialize((params): InitializeResult = {  ...  return {  capabilities: {  // Enable incremental document sync  textDocumentSync: TextDocumentSyncKind.Incremental,  ...  }  }; });  connection.onDidOpenTextDocument((params) = {  // A text document was opened in VS Code.  // params.uri uniquely identifies the document. For documents stored on disk, this is a file URI.  // params.text the initial full content of the document. });  connection.onDidChangeTextDocument((params) = {  // The content of a text document has change in VS Code.  // params.uri uniquely identifies the document.  // params.contentChanges describe the content changes to the document. });  connection.onDidCloseTextDocument((params) = {  // A text document was closed in VS Code.  // params.uri uniquely identifies the document. });   直接使用 VS Code API 来实现语言功能 虽然语言服务器有很多好处，但它们不是扩展 VS Code 编辑能力的唯一选择。在你想为一种类型的文档添加一些简单的语言功能的情况下，可以考虑使用 vscode.languages.register[LANGUAGE_FEATURE]Provider 作为一种选择。\n下面是一个使用 vscode.languages.registerCompletionItemProvider 为纯文本文件添加一些片段作为补语的例子。\n更多说明 VS Code API 用法的例子可以在https://github.com/microsoft/vscode-extension-samples。\n语言服务器的容错解析器 大多数时候，编辑器中的代码是不完整的，语法上也是不正确的，但开发人员仍然希望自动完成和其他语言功能能够工作。因此，对于语言服务器来说，一个容错的解析器是必要的。解析器从部分完整的代码中生成有意义的 AST，而语言服务器则根据 AST 提供语言功能。\n当我们在 VS Code 中改进对 PHP 的支持时，我们意识到官方的 PHP 解析器不是容错的，不能直接在语言服务器中重复使用。因此，我们在 Microsoft/tolerant-php-parser 上做了工作，并留下了详细的注释，这可能有助于需要实现容错解析器的语言服务器作者。\n常见的问题 当我试图连接到服务器时，我得到 “无法连接到运行时进程（5000ms 后超时）\"？\n如果在你尝试连接调试器时，服务器没有运行，你会看到这个超时错误。客户端会启动语言服务器，所以要确保你已经启动了客户端，以便有一个正在运行的服务器。如果你的客户端断点干扰了服务器的启动，你可能还需要禁用你的客户端断点。\n我已经读完了本指南和 LSP 规范，但我仍有一些问题没有解决。我在哪里可以得到帮助？\n请在https://github.com/microsoft/language-server-protocol 上开一个问题。\n","wordCount":"2958","inLanguage":"en","datePublished":"2022-04-30T18:53:11+08:00","dateModified":"2022-04-30T18:53:11+08:00","author":{"@type":"Person","name":"Fenix"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhenfeng-zhu.github.io/post/lsp-intro/"},"publisher":{"@type":"Organization","name":"Awesome Fenix","logo":{"@type":"ImageObject","url":"https://zhenfeng-zhu.github.io/favicon.ico"}}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8502076734034112" crossorigin=anonymous></script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8502076734034112" crossorigin=anonymous></script><header class=header><nav class=nav><div class=logo><a href=https://zhenfeng-zhu.github.io accesskey=h title="Awesome Fenix (Alt + H)">Awesome Fenix</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://zhenfeng-zhu.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://zhenfeng-zhu.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://zhenfeng-zhu.github.io/about title=About><span>About</span></a></li><li><a href=https://zhenfeng-zhu.github.io/search/ title=🔍><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zhenfeng-zhu.github.io>Home</a>&nbsp;»&nbsp;<a href=https://zhenfeng-zhu.github.io/post/>Posts</a></div><h1 class=post-title>Lsp Intro</h1><div class=post-meta><span title="2022-04-30 18:53:11 +0800 +0800">April 30, 2022</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;Fenix&nbsp;|&nbsp;<a href=https://github.com/zhenfeng-zhu/zhenfeng-zhu.github.io/tree/main/content/post/lsp-intro.md rel="noopener noreferrer" target=_blank>修改本文章</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e6%98%af%e8%af%ad%e8%a8%80%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=为什么是语言服务器>为什么是语言服务器</a></li><li><a href=#%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa%e8%af%ad%e8%a8%80%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=实现一个语言服务器>实现一个语言服务器</a><ul><li><a href=#%e6%a6%82%e8%bf%b0 aria-label=概述>概述</a></li><li><a href=#lsp-%e6%a0%b7%e4%be%8b----%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%e7%ba%af%e6%96%87%e6%9c%ac%e6%96%87%e4%bb%b6%e7%9a%84%e8%af%ad%e8%a8%80%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label="LSP 样例  - 一个简单的纯文本文件的语言服务器">LSP 样例 - 一个简单的纯文本文件的语言服务器</a></li><li><a href=#%e8%af%a6%e8%a7%a3-%e8%af%ad%e8%a8%80%e5%ae%a2%e6%88%b7%e7%ab%af aria-label="详解 “语言客户端&amp;quot;">详解 “语言客户端"</a></li><li><a href=#%e8%af%a6%e8%a7%a3%e8%af%ad%e8%a8%80%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=详解语言服务器>详解语言服务器</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84%e9%aa%8c%e8%af%81%e5%8a%9f%e8%83%bd aria-label=添加一个简单的验证功能>添加一个简单的验证功能</a></li><li><a href=#%e8%af%8a%e6%96%ad%e6%8a%80%e5%b7%a7%e5%92%8c%e7%aa%8d%e9%97%a8 aria-label=诊断技巧和窍门>诊断技巧和窍门</a></li><li><a href=#%e5%90%8c%e6%97%b6%e8%b0%83%e8%af%95%e5%ae%a2%e6%88%b7%e7%ab%af%e5%92%8c%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=同时调试客户端和服务器>同时调试客户端和服务器</a></li><li><a href=#%e8%af%ad%e8%a8%80%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e6%97%a5%e5%bf%97%e6%94%af%e6%8c%81 aria-label=语言服务器的日志支持>语言服务器的日志支持</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%ad%e7%9a%84%e9%85%8d%e7%bd%ae aria-label=使用服务器中的配置>使用服务器中的配置</a></li><li><a href=#%e6%b7%bb%e5%8a%a0%e9%a2%9d%e5%a4%96%e7%9a%84%e8%af%ad%e8%a8%80%e5%8a%9f%e8%83%bd aria-label=添加额外的语言功能>添加额外的语言功能</a></li><li><a href=#%e6%b5%8b%e8%af%95%e8%af%ad%e8%a8%80%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label=测试语言服务器>测试语言服务器</a></li></ul></li><li><a href=#%e9%ab%98%e7%ba%a7%e4%b8%bb%e9%a2%98 aria-label=高级主题>高级主题</a><ul><li><a href=#%e9%a2%9d%e5%a4%96%e7%9a%84%e8%af%ad%e8%a8%80%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%8a%9f%e8%83%bd aria-label=额外的语言服务器功能>额外的语言服务器功能</a></li><li><a href=#%e5%a2%9e%e9%87%8f%e5%bc%8f%e6%96%87%e6%9c%ac%e6%96%87%e4%bb%b6%e5%90%8c%e6%ad%a5 aria-label=增量式文本文件同步>增量式文本文件同步</a></li><li><a href=#%e7%9b%b4%e6%8e%a5%e4%bd%bf%e7%94%a8-vs-code-api-%e6%9d%a5%e5%ae%9e%e7%8e%b0%e8%af%ad%e8%a8%80%e5%8a%9f%e8%83%bd aria-label="直接使用 VS Code API 来实现语言功能">直接使用 VS Code API 来实现语言功能</a></li><li><a href=#%e8%af%ad%e8%a8%80%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e5%ae%b9%e9%94%99%e8%a7%a3%e6%9e%90%e5%99%a8 aria-label=语言服务器的容错解析器>语言服务器的容错解析器</a></li></ul></li><li><a href=#%e5%b8%b8%e8%a7%81%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=常见的问题>常见的问题</a></li></ul></div></details></div><div class=post-content><h1 id=为什么是语言服务器>为什么是语言服务器<a hidden class=anchor aria-hidden=true href=#为什么是语言服务器>#</a></h1><p>语言服务器是一种特殊的 Visual Studio Code 扩展，为许多编程语言的编辑体验提供动力。通过语言服务器，你可以实现自动完成、错误检查（诊断）、跳转到定义，以及 VS Code 中支持的许多其他语言功能。</p><p>然而，在实现对 VS Code 中语言功能的支持时，我们发现了三个常见的问题:</p><p>首先，语言服务器通常是用他们的本地编程语言实现的，这给他们与具有 Node.js 运行时间的 VS Code 集成带来了挑战。</p><p>此外，语言功能可能是资源密集型的。例如，为了正确验证一个文件，语言服务器需要解析大量的文件，为它们建立抽象语法树并进行静态程序分析。这些操作可能会产生大量的 CPU 和内存占用，我们需要确保 VS Code 的性能不受影响。</p><p>最后，将多种语言工具与多种代码编辑器整合在一起，可能会涉及大量的工作。从语言工具的角度来看，他们需要适应具有不同 API 的代码编辑器。从代码编辑器的角度来看，他们不能期望从语言工具中获得任何统一的 API。这使得在 N 个代码编辑器中实现对 M 种语言的语言支持成为 M*N 的工作。</p><p>为了解决这些问题，微软制定了语言服务器协议，它使语言工具和代码编辑器之间的通信标准化。这样，语言服务器可以用任何语言实现，并在自己的进程中运行，以避免性能成本，因为它们通过语言服务器协议与代码编辑器通信。此外，任何符合 LSP 的语言工具都可以与多个符合 LSP 的代码编辑器集成，任何符合 LSP 的代码编辑器都可以轻易地接上多个符合 LSP 的语言工具。LSP 对于语言工具供应商和代码编辑器供应商来说都是一种共赢。</p><p><img loading=lazy src=https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/lsp-languages-editors.png alt="LSP Languages and Editors"></p><h1 id=实现一个语言服务器>实现一个语言服务器<a hidden class=anchor aria-hidden=true href=#实现一个语言服务器>#</a></h1><h2 id=概述>概述<a hidden class=anchor aria-hidden=true href=#概述>#</a></h2><p>在 VS Code 中，一个语言服务器有两个部分：</p><ul><li>语言客户端。一个用 JavaScript/TypeScript 编写的普通 VS Code 扩展。这个扩展可以访问所有 VS Code 的命名空间 API。</li><li>语言服务器。一个在独立进程中运行的语言分析工具。</li></ul><p>如上所述，在一个单独的进程中运行语言服务器有两个好处：</p><ul><li>分析工具可以用任何语言实现，只要它能按照语言服务器协议与语言客户端通信。</li><li>由于语言分析工具通常对 CPU 和内存的使用率很高，在单独的进程中运行它们可以避免性能成本。</li></ul><p>下面是一个 VS Code 运行两个语言服务器扩展的例子：</p><p>HTML 语言客户端和 PHP 语言客户端是用 TypeScript 编写的普通 VS Code 扩展。它们中的每一个都实例化了一个相应的语言服务器，并通过 LSP 与它们进行通信。虽然 PHP 语言服务器是用 PHP 编写的，但它仍然可以通过 LSP 与 PHP 语言客户端进行通信。</p><p><img loading=lazy src=https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/lsp-illustration.png alt="LSP Illustration"></p><p>本指南将教你如何使用我们的 Node SDK 建立一个语言客户端/服务器。其余的文件假定你熟悉 VS Code Extension API。</p><h2 id=lsp-样例----一个简单的纯文本文件的语言服务器>LSP 样例 - 一个简单的纯文本文件的语言服务器<a hidden class=anchor aria-hidden=true href=#lsp-样例----一个简单的纯文本文件的语言服务器>#</a></h2><p>让我们建立一个简单的语言服务器扩展，为纯文本文件实现自动完成和诊断功能。我们还将涵盖客户端/服务器之间的配置同步。</p><p>如果你喜欢直接跳到代码中：</p><ul><li>lsp-sample 本指南有大量的源代码。</li><li>lsp-multi-server-sample，lsp-sample 的高级版本，它为每个工作区文件夹启动一个不同的服务器实例，以支持 VS Code 中的多根工作区功能。</li></ul><p>克隆存储库 Microsoft/vscode-extension-samples 并打开样例：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5>5</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; git clone https://github.com/microsoft/vscode-extension-samples.git
</span></span><span style=display:flex><span>&gt; cd vscode-extension-samples/lsp-sample
</span></span><span style=display:flex><span>&gt; npm install
</span></span><span style=display:flex><span>&gt; npm run compile
</span></span><span style=display:flex><span>&gt; code .
</span></span></code></pre></td></tr></table></div></div><p>以上安装了所有的依赖项，并打开了包含客户端和服务器代码的 lsp-sample 工作区。下面是 lsp-sample 结构的一个粗略概述:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5>5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6>6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7>7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8>8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9>9</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── client // Language Client
</span></span><span style=display:flex><span>│   ├── src
</span></span><span style=display:flex><span>│   │   ├── test // End to End tests <span style=color:#66d9ef>for</span> Language Client / Server
</span></span><span style=display:flex><span>│   │   └── extension.ts // Language Client entry point
</span></span><span style=display:flex><span>├── package.json // The extension manifest
</span></span><span style=display:flex><span>└── server // Language Server
</span></span><span style=display:flex><span>    └── src
</span></span><span style=display:flex><span>        └── server.ts // Language Server entry point
</span></span></code></pre></td></tr></table></div></div><h2 id=详解-语言客户端>详解 “语言客户端"<a hidden class=anchor aria-hidden=true href=#详解-语言客户端>#</a></h2><p>我们先来看看<code>/package.json</code>，它描述了语言客户端的能力。这里有三个有趣的部分。</p><p>首先看激活事件（<code>activationEvents</code>）:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;activationEvents&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;onLanguage:plaintext&#34;</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></td></tr></table></div></div><p>这一部分告诉 VS Code，一旦打开纯文本文件（例如扩展名为.txt 的文件），就立即激活扩展。</p><p>接下来看看配置部分:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-12>12</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;configuration&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Example configuration&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;properties&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;languageServerExample.maxNumberOfProblems&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;scope&#34;</span>: <span style=color:#e6db74>&#34;resource&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;number&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;default&#34;</span>: <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Controls the maximum number of problems produced by the server.&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>本节为 VS Code 提供了配置设置。这个例子将解释这些设置是如何在启动时和每次改变设置时发送到语言服务器上的。</p><p>实际的语言客户端源代码和相应的 <code>package.json</code> 在<code>/client</code> 文件夹中。</p><p><code>/client/package.json</code> 文件中有趣的部分是，它通过引擎字段引用了 vscode 扩展主机 API，并添加了对 <code>vscode-languageclient</code> 库的依赖:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4>4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5>5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6>6</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;engines&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;vscode&#34;</span>: <span style=color:#e6db74>&#34;^1.52.0&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;dependencies&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;vscode-languageclient&#34;</span>: <span style=color:#e6db74>&#34;^7.0.0&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>如前所述，客户端被实现为一个普通的 VS Code 扩展，它可以访问所有 VS Code 命名空间的 API。</p><p>下面是相应的 extension.ts 文件的内容，它是 lsp-sample 完整代码:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-41>41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-42>42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-43>43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-44>44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-45>45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-46>46</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-47>47</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-48>48</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-49>49</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-50>50</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-51>51</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-52>52</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-53>53</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-54>54</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-55>55</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-56>56</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-57>57</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>workspace</span>, <span style=color:#a6e22e>ExtensionContext</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;vscode&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>LanguageClient</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>LanguageClientOptions</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ServerOptions</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TransportKind</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;vscode-languageclient/node&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>client</span>: <span style=color:#66d9ef>LanguageClient</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>activate</span>(<span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>ExtensionContext</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// The server is implemented in node
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>serverModule</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>asAbsolutePath</span>(<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;server&#39;</span>, <span style=color:#e6db74>&#39;out&#39;</span>, <span style=color:#e6db74>&#39;server.js&#39;</span>));
</span></span><span style=display:flex><span>  <span style=color:#75715e>// The debug options for the server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// --inspect=6009: runs the server in Node&#39;s Inspector mode so VS Code can attach to the server for debugging
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>debugOptions</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>execArgv</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;--nolazy&#39;</span>, <span style=color:#e6db74>&#39;--inspect=6009&#39;</span>] };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// If the extension is launched in debug mode then the debug server options are used
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// Otherwise the run options are used
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>serverOptions</span>: <span style=color:#66d9ef>ServerOptions</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>run</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>module</span>: <span style=color:#66d9ef>serverModule</span>, <span style=color:#a6e22e>transport</span>: <span style=color:#66d9ef>TransportKind.ipc</span> },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debug</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>module</span>: <span style=color:#66d9ef>serverModule</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>transport</span>: <span style=color:#66d9ef>TransportKind.ipc</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>options</span>: <span style=color:#66d9ef>debugOptions</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Options to control the language client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>clientOptions</span>: <span style=color:#66d9ef>LanguageClientOptions</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Register the server for plain text documents
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>documentSelector</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>scheme</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;file&#39;</span>, <span style=color:#a6e22e>language</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;plaintext&#39;</span> }],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>synchronize</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Notify the server about file changes to &#39;.clientrc files contained in the workspace
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>fileEvents</span>: <span style=color:#66d9ef>workspace.createFileSystemWatcher</span>(<span style=color:#e6db74>&#39;**/.clientrc&#39;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Create the language client and start the client.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LanguageClient</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;languageServerExample&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;Language Server Example&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serverOptions</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>clientOptions</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Start the client. This will also launch the server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>start</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>deactivate</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Thenable</span>&lt;<span style=color:#f92672>void</span>&gt; <span style=color:#f92672>|</span> <span style=color:#66d9ef>undefined</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>client</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>undefined</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>stop</span>();
</span></span></code></pre></td></tr></table></div></div><h2 id=详解语言服务器>详解语言服务器<a hidden class=anchor aria-hidden=true href=#详解语言服务器>#</a></h2><p>在这个例子中，服务器也是用 TypeScript 实现的，并使用 Node.js 执行。由于 VS Code 已经带有 Node.js 的运行时间，所以没有必要提供你自己的，除非你对运行时间有特殊要求。</p><p>语言服务器的源代码在<code>/server</code>。在服务器的 <code>package.json</code> 文件中，有趣的部分是:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3>3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#e6db74>&#34;dependencies&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;vscode-languageserver&#34;</span>: <span style=color:#e6db74>&#34;^7.0.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;vscode-languageserver-textdocument&#34;</span>: <span style=color:#e6db74>&#34;^1.0.1&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这就引入了 vscode-languageserver 库。</p><p>下面是一个服务器的实现，它使用了所提供的简单的文本文档管理器，通过总是将文件的完整内容从 VS Code 发送到服务器来同步文本文档:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1>  1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2>  2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3>  3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4>  4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5>  5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6>  6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7>  7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8>  8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9>  9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10> 10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11> 11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12> 12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13> 13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14> 14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15> 15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16> 16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17> 17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18> 18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19> 19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20> 20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21> 21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22> 22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-23> 23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-24> 24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-25> 25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-26> 26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-27> 27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-28> 28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-29> 29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-30> 30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-31> 31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-32> 32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-33> 33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-34> 34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-35> 35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-36> 36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-37> 37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-38> 38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-39> 39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-40> 40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-41> 41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-42> 42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-43> 43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-44> 44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-45> 45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-46> 46</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-47> 47</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-48> 48</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-49> 49</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-50> 50</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-51> 51</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-52> 52</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-53> 53</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-54> 54</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-55> 55</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-56> 56</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-57> 57</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-58> 58</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-59> 59</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-60> 60</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-61> 61</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-62> 62</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-63> 63</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-64> 64</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-65> 65</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-66> 66</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-67> 67</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-68> 68</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-69> 69</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-70> 70</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-71> 71</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-72> 72</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-73> 73</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-74> 74</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-75> 75</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-76> 76</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-77> 77</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-78> 78</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-79> 79</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-80> 80</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-81> 81</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-82> 82</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-83> 83</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-84> 84</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-85> 85</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-86> 86</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-87> 87</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-88> 88</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-89><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-89> 89</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-90><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-90> 90</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-91><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-91> 91</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-92><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-92> 92</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-93><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-93> 93</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-94><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-94> 94</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-95><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-95> 95</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-96><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-96> 96</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-97><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-97> 97</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-98><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-98> 98</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-99><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-99> 99</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-100><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-100>100</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-101><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-101>101</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-102><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-102>102</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-103><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-103>103</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-104><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-104>104</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-105><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-105>105</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-106><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-106>106</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-107><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-107>107</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-108><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-108>108</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-109><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-109>109</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-110><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-110>110</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-111><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-111>111</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-112><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-112>112</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-113><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-113>113</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-114><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-114>114</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-115><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-115>115</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-116><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-116>116</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-117><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-117>117</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-118><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-118>118</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-119><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-119>119</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-120><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-120>120</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-121><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-121>121</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-122><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-122>122</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-123><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-123>123</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-124><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-124>124</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-125><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-125>125</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-126><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-126>126</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-127><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-127>127</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-128><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-128>128</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-129><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-129>129</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-130><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-130>130</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-131><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-131>131</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-132><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-132>132</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-133><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-133>133</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-134><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-134>134</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-135><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-135>135</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-136><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-136>136</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-137><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-137>137</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-138><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-138>138</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-139><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-139>139</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-140><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-140>140</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-141><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-141>141</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-142><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-142>142</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-143><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-143>143</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-144><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-144>144</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-145><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-145>145</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-146><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-146>146</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-147><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-147>147</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-148><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-148>148</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-149><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-149>149</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-150><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-150>150</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-151><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-151>151</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-152><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-152>152</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-153><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-153>153</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-154><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-154>154</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-155><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-155>155</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-156><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-156>156</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-157><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-157>157</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-158><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-158>158</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-159><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-159>159</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-160><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-160>160</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-161><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-161>161</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-162><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-162>162</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-163><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-163>163</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-164><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-164>164</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-165><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-165>165</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-166><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-166>166</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-167><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-167>167</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-168><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-168>168</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-169><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-169>169</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-170><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-170>170</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-171><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-171>171</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-172><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-172>172</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-173><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-173>173</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-174><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-174>174</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-175><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-175>175</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-176><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-176>176</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-177><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-177>177</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-178><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-178>178</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-179><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-179>179</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-180><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-180>180</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-181><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-181>181</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-182><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-182>182</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-183><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-183>183</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-184><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-184>184</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-185><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-185>185</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-186><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-186>186</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-187><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-187>187</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-188><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-188>188</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-189><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-189>189</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-190><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-190>190</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-191><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-191>191</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-192><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-192>192</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-193><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-193>193</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-194><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-194>194</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-195><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-195>195</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-196><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-196>196</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-197><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-197>197</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-198><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-198>198</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-199><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-199>199</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-200><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-200>200</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-201><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-201>201</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-202><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-202>202</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-203><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-203>203</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-204><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-204>204</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-205><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-205>205</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-206><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-206>206</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-207><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-207>207</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-208><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-208>208</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-209><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-209>209</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-210><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-210>210</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-211><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-211>211</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-212><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-212>212</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-213><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-213>213</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-214><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-214>214</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-215><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-215>215</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-216><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-216>216</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-217><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-217>217</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-218><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-218>218</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-219><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-219>219</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-220><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-220>220</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-221><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-221>221</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-222><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-222>222</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-223><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-223>223</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-224><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-224>224</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>createConnection</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TextDocuments</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Diagnostic</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DiagnosticSeverity</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ProposedFeatures</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>InitializeParams</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DidChangeConfigurationNotification</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CompletionItem</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CompletionItemKind</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TextDocumentPositionParams</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TextDocumentSyncKind</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>InitializeResult</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;vscode-languageserver/node&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>TextDocument</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;vscode-languageserver-textdocument&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create a connection for the server, using Node&#39;s IPC as a transport.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Also include all preview / proposed LSP features.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>connection</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createConnection</span>(<span style=color:#a6e22e>ProposedFeatures</span>.<span style=color:#a6e22e>all</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create a simple text document manager.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>documents</span>: <span style=color:#66d9ef>TextDocuments</span>&lt;<span style=color:#f92672>TextDocument</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TextDocuments</span>(<span style=color:#a6e22e>TextDocument</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hasConfigurationCapability</span>: <span style=color:#66d9ef>boolean</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hasWorkspaceFolderCapability</span>: <span style=color:#66d9ef>boolean</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hasDiagnosticRelatedInformationCapability</span>: <span style=color:#66d9ef>boolean</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onInitialize</span>((<span style=color:#a6e22e>params</span>: <span style=color:#66d9ef>InitializeParams</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>capabilities</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>capabilities</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Does the client support the `workspace/configuration` request?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// If not, we fall back using global settings.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>hasConfigurationCapability</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!!</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capabilities</span>.<span style=color:#a6e22e>workspace</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!!</span><span style=color:#a6e22e>capabilities</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>configuration</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hasWorkspaceFolderCapability</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!!</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capabilities</span>.<span style=color:#a6e22e>workspace</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!!</span><span style=color:#a6e22e>capabilities</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>workspaceFolders</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>hasDiagnosticRelatedInformationCapability</span> <span style=color:#f92672>=</span> <span style=color:#f92672>!!</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capabilities</span>.<span style=color:#a6e22e>textDocument</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capabilities</span>.<span style=color:#a6e22e>textDocument</span>.<span style=color:#a6e22e>publishDiagnostics</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capabilities</span>.<span style=color:#a6e22e>textDocument</span>.<span style=color:#a6e22e>publishDiagnostics</span>.<span style=color:#a6e22e>relatedInformation</span>
</span></span><span style=display:flex><span>  );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>InitializeResult</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capabilities</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>textDocumentSync</span>: <span style=color:#66d9ef>TextDocumentSyncKind.Incremental</span>,
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Tell the client that this server supports code completion.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>completionProvider</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolveProvider</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasWorkspaceFolderCapability</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>capabilities</span>.<span style=color:#a6e22e>workspace</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workspaceFolders</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>supported</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onInitialized</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasConfigurationCapability</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Register for all configuration changes.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>register</span>(<span style=color:#a6e22e>DidChangeConfigurationNotification</span>.<span style=color:#66d9ef>type</span>, <span style=color:#66d9ef>undefined</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasWorkspaceFolderCapability</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>onDidChangeWorkspaceFolders</span>(<span style=color:#a6e22e>_event</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Workspace folder change event received.&#39;</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The example settings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ExampleSettings</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>maxNumberOfProblems</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The global settings, used when the `workspace/configuration` request is not supported by the client.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Please note that this is not the case when using this server with the client provided in this example
</span></span></span><span style=display:flex><span><span style=color:#75715e>// but could happen with other clients.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>defaultSettings</span>: <span style=color:#66d9ef>ExampleSettings</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>maxNumberOfProblems</span>: <span style=color:#66d9ef>1000</span> };
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>globalSettings</span>: <span style=color:#66d9ef>ExampleSettings</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>defaultSettings</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Cache the settings of all open documents
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>documentSettings</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>Thenable</span><span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#a6e22e>ExampleSettings</span>&gt;<span style=color:#f92672>&gt;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onDidChangeConfiguration</span>(<span style=color:#a6e22e>change</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasConfigurationCapability</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Reset all cached document settings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>documentSettings</span>.<span style=color:#a6e22e>clear</span>();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>globalSettings</span> <span style=color:#f92672>=</span> &lt;<span style=color:#f92672>ExampleSettings</span>&gt;(
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>change</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>languageServerExample</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>defaultSettings</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Revalidate all open text documents
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>documents</span>.<span style=color:#a6e22e>all</span>().<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>validateTextDocument</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getDocumentSettings</span>(<span style=color:#a6e22e>resource</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Thenable</span>&lt;<span style=color:#f92672>ExampleSettings</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasConfigurationCapability</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>globalSettings</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>documentSettings</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>resource</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>result</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>getConfiguration</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>scopeUri</span>: <span style=color:#66d9ef>resource</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>section</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;languageServerExample&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>documentSettings</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Only keep settings for open documents
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>documents</span>.<span style=color:#a6e22e>onDidClose</span>(<span style=color:#a6e22e>e</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>documentSettings</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>e</span>.document.<span style=color:#a6e22e>uri</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// The content of a text document has changed. This event is emitted
</span></span></span><span style=display:flex><span><span style=color:#75715e>// when the text document first opened or when its content has changed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>documents</span>.<span style=color:#a6e22e>onDidChangeContent</span>(<span style=color:#a6e22e>change</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>validateTextDocument</span>(<span style=color:#a6e22e>change</span>.document);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>validateTextDocument</span>(<span style=color:#a6e22e>textDocument</span>: <span style=color:#66d9ef>TextDocument</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// In this simple example we get the settings for every validate run.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>settings</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>getDocumentSettings</span>(<span style=color:#a6e22e>textDocument</span>.<span style=color:#a6e22e>uri</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// The validator creates diagnostics for all uppercase words length 2 and more
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>textDocument</span>.<span style=color:#a6e22e>getText</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>pattern</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/\b[A-Z]{2,}\b/g</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>m</span>: <span style=color:#66d9ef>RegExpExecArray</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>problems</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>diagnostics</span>: <span style=color:#66d9ef>Diagnostic</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ((<span style=color:#a6e22e>m</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pattern</span>.<span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>text</span>)) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>problems</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>maxNumberOfProblems</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>problems</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>diagnostic</span>: <span style=color:#66d9ef>Diagnostic</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>severity</span>: <span style=color:#66d9ef>DiagnosticSeverity.Warning</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>range</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>start</span>: <span style=color:#66d9ef>textDocument.positionAt</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>index</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>end</span>: <span style=color:#66d9ef>textDocument.positionAt</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>index</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>m</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>length</span>)
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>m</span>[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74> is all uppercase.`</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ex&#39;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasDiagnosticRelatedInformationCapability</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>relatedInformation</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>range</span>: <span style=color:#66d9ef>Object.assign</span>({}, <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>range</span>)
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Spelling matters&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>range</span>: <span style=color:#66d9ef>Object.assign</span>({}, <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>range</span>)
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Particularly for names&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>diagnostics</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>diagnostic</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Send the computed diagnostics to VS Code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>sendDiagnostics</span>({ <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>, <span style=color:#a6e22e>diagnostics</span> });
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onDidChangeWatchedFiles</span>(<span style=color:#a6e22e>_change</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Monitored files have change in VS Code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;We received a file change event&#39;</span>);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// This handler provides the initial list of the completion items.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onCompletion</span>(
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>_textDocumentPosition</span>: <span style=color:#66d9ef>TextDocumentPositionParams</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>CompletionItem</span>[] <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The pass parameter contains the position of the text document in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// which code complete got requested. For the example we ignore this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// info and always provide the same completion items.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>label</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TypeScript&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kind</span>: <span style=color:#66d9ef>CompletionItemKind.Text</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>1</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>label</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;JavaScript&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kind</span>: <span style=color:#66d9ef>CompletionItemKind.Text</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>2</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// This handler resolves additional information for the item selected in
</span></span></span><span style=display:flex><span><span style=color:#75715e>// the completion list.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onCompletionResolve</span>(
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>item</span>: <span style=color:#66d9ef>CompletionItem</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>CompletionItem</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>data</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>detail</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TypeScript details&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>documentation</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TypeScript documentation&#39;</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>data</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>detail</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;JavaScript details&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>documentation</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;JavaScript documentation&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>item</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Make the text document manager listen on the connection
</span></span></span><span style=display:flex><span><span style=color:#75715e>// for open, change and close text document events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>documents</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>connection</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Listen on the connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>listen</span>();
</span></span></code></pre></td></tr></table></div></div><h2 id=添加一个简单的验证功能>添加一个简单的验证功能<a hidden class=anchor aria-hidden=true href=#添加一个简单的验证功能>#</a></h2><p>为了给服务器添加文档验证，我们给文本文档管理器添加了一个监听器，每当文本文档的内容发生变化时就会被调用。然后由服务器来决定何时是验证文档的最佳时机。在这个例子的实现中，服务器验证纯文本文档，并标记所有使用大写字母的单词的出现。相应的代码片段看起来像这样:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-41>41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-42>42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-43>43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-44>44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-45>45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-46>46</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-47>47</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-48>48</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-49>49</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// The content of a text document has changed. This event is emitted
</span></span></span><span style=display:flex><span><span style=color:#75715e>// when the text document first opened or when its content has changed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>documents</span>.<span style=color:#a6e22e>onDidChangeContent</span>(<span style=color:#66d9ef>async</span> <span style=color:#a6e22e>change</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>textDocument</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>change</span>.document;
</span></span><span style=display:flex><span>  <span style=color:#75715e>// In this simple example we get the settings for every validate run.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>settings</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>getDocumentSettings</span>(<span style=color:#a6e22e>textDocument</span>.<span style=color:#a6e22e>uri</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// The validator creates diagnostics for all uppercase words length 2 and more
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>textDocument</span>.<span style=color:#a6e22e>getText</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>pattern</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/\b[A-Z]{2,}\b/g</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>m</span>: <span style=color:#66d9ef>RegExpExecArray</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>problems</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>diagnostics</span>: <span style=color:#66d9ef>Diagnostic</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ((<span style=color:#a6e22e>m</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pattern</span>.<span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>text</span>)) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>problems</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>maxNumberOfProblems</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>problems</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>diagnostic</span>: <span style=color:#66d9ef>Diagnostic</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>severity</span>: <span style=color:#66d9ef>DiagnosticSeverity.Warning</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>range</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>start</span>: <span style=color:#66d9ef>textDocument.positionAt</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>index</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>end</span>: <span style=color:#66d9ef>textDocument.positionAt</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>index</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>m</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>length</span>)
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>m</span>[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74> is all uppercase.`</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ex&#39;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasDiagnosticRelatedInformationCapability</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>relatedInformation</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>range</span>: <span style=color:#66d9ef>Object.assign</span>({}, <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>range</span>)
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Spelling matters&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>range</span>: <span style=color:#66d9ef>Object.assign</span>({}, <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>range</span>)
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Particularly for names&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>diagnostics</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>diagnostic</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Send the computed diagnostics to VS Code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>sendDiagnostics</span>({ <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>, <span style=color:#a6e22e>diagnostics</span> });
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><h2 id=诊断技巧和窍门>诊断技巧和窍门<a hidden class=anchor aria-hidden=true href=#诊断技巧和窍门>#</a></h2><p>如果开始和结束的位置相同，VS Code 将在该位置用斜线划出单词。 如果你想用斜线划线，直到行的末尾，那么将末尾位置的字符设置为 Number.MAX_VALUE。 要运行语言服务器，请执行以下步骤。</p><p>按⇧ ⌘B 启动构建任务。这个任务会同时编译客户端和服务器。
打开运行视图，选择 Launch Client 启动配置，按 Start Debugging 按钮，启动一个额外的 VS Code 的扩展开发主机实例，执行扩展代码。
在根目录下创建一个 test.txt 文件，粘贴以下内容:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1>1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2>2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3>3</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>TypeScript lets you write JavaScript the way you really want to.
</span></span><span style=display:flex><span>TypeScript is a typed superset of JavaScript that compiles to plain JavaScript.
</span></span><span style=display:flex><span>ANY browser. ANY host. ANY OS. Open Source.
</span></span></code></pre></td></tr></table></div></div><p>然后，扩展开发主机实例将看起来像这样:</p><p><img loading=lazy src=https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/validation.png alt="Validating a text file"></p><h2 id=同时调试客户端和服务器>同时调试客户端和服务器<a hidden class=anchor aria-hidden=true href=#同时调试客户端和服务器>#</a></h2><p>调试客户端代码和调试普通扩展一样简单。在客户端代码中设置一个断点，按 F5 键调试扩展。</p><p><img loading=lazy src=https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/debugging-client.png alt="Debugging the client"></p><p>由于服务器是由在扩展程序（客户端）中运行的 LanguageClient 启动的，我们需要将调试器附加到运行的服务器上。要做到这一点，请切换到运行视图，选择启动配置 Attach to Server 并按 F5。这将把调试器附加到服务器上。</p><p><img loading=lazy src=https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/debugging-server.png alt="Debugging the server"></p><h2 id=语言服务器的日志支持>语言服务器的日志支持<a hidden class=anchor aria-hidden=true href=#语言服务器的日志支持>#</a></h2><p>如果你使用 vscode-languageclient 来实现客户端，你可以指定一个设置[langId].trace.server，指示客户端将语言客户端/服务器之间的通信记录到语言客户端名称的通道中。</p><p>对于 lsp-sample，你可以配置这个设置。<code>"languageServerExample.trace.server": "verbose"</code>。现在前往 &ldquo;语言服务器示例 &ldquo;频道。你应该看到日志:</p><p><img loading=lazy src=https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/lsp-log.png alt="LSP Log"></p><h2 id=使用服务器中的配置>使用服务器中的配置<a hidden class=anchor aria-hidden=true href=#使用服务器中的配置>#</a></h2><p>在编写扩展的客户端部分时，我们已经定义了一个设置来控制报告问题的最大数量。我们还在服务器端写了代码，从客户端读取这些设置。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getDocumentSettings</span>(<span style=color:#a6e22e>resource</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Thenable</span>&lt;<span style=color:#f92672>ExampleSettings</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasConfigurationCapability</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>globalSettings</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>documentSettings</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>resource</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>result</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>getConfiguration</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>scopeUri</span>: <span style=color:#66d9ef>resource</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>section</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;languageServerExample&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>documentSettings</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>resource</span>, <span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>我们现在唯一需要做的是监听服务器端的配置变化，如果设置发生变化，就重新验证打开的文本文档。为了能够重复使用文档变化事件处理的验证逻辑，我们将代码提取到 validateTextDocument 函数中，并修改代码以尊重 maxNumberOfProblems 变量:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-38>38</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-39>39</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-40>40</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-41>41</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-42>42</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-43>43</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-44>44</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-45>45</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-46>46</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>validateTextDocument</span>(<span style=color:#a6e22e>textDocument</span>: <span style=color:#66d9ef>TextDocument</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// In this simple example we get the settings for every validate run.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>settings</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>getDocumentSettings</span>(<span style=color:#a6e22e>textDocument</span>.<span style=color:#a6e22e>uri</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// The validator creates diagnostics for all uppercase words length 2 and more
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>text</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>textDocument</span>.<span style=color:#a6e22e>getText</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>pattern</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/\b[A-Z]{2,}\b/g</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>m</span>: <span style=color:#66d9ef>RegExpExecArray</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>problems</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>diagnostics</span>: <span style=color:#66d9ef>Diagnostic</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> ((<span style=color:#a6e22e>m</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pattern</span>.<span style=color:#a6e22e>exec</span>(<span style=color:#a6e22e>text</span>)) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>problems</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>maxNumberOfProblems</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>problems</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>diagnostic</span>: <span style=color:#66d9ef>Diagnostic</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>severity</span>: <span style=color:#66d9ef>DiagnosticSeverity.Warning</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>range</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>start</span>: <span style=color:#66d9ef>textDocument.positionAt</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>index</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>end</span>: <span style=color:#66d9ef>textDocument.positionAt</span>(<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>index</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>m</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>length</span>)
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>m</span>[<span style=color:#ae81ff>0</span>]<span style=color:#e6db74>}</span><span style=color:#e6db74> is all uppercase.`</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ex&#39;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasDiagnosticRelatedInformationCapability</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>relatedInformation</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>range</span>: <span style=color:#66d9ef>Object.assign</span>({}, <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>range</span>)
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Spelling matters&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>range</span>: <span style=color:#66d9ef>Object.assign</span>({}, <span style=color:#a6e22e>diagnostic</span>.<span style=color:#a6e22e>range</span>)
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Particularly for names&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>diagnostics</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>diagnostic</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Send the computed diagnostics to VS Code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>sendDiagnostics</span>({ <span style=color:#a6e22e>uri</span>: <span style=color:#66d9ef>textDocument.uri</span>, <span style=color:#a6e22e>diagnostics</span> });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>对配置变化的处理是通过在连接中添加一个配置变化的通知处理程序来完成的。相应的代码看起来像这样:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-13>13</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onDidChangeConfiguration</span>(<span style=color:#a6e22e>change</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasConfigurationCapability</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Reset all cached document settings
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>documentSettings</span>.<span style=color:#a6e22e>clear</span>();
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>globalSettings</span> <span style=color:#f92672>=</span> &lt;<span style=color:#f92672>ExampleSettings</span>&gt;(
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>change</span>.<span style=color:#a6e22e>settings</span>.<span style=color:#a6e22e>languageServerExample</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>defaultSettings</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Revalidate all open text documents
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>documents</span>.<span style=color:#a6e22e>all</span>().<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>validateTextDocument</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><p>再次启动客户端，并将设置改为最大报告 1 个问题，结果出现以下验证:</p><p><img loading=lazy src=https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/validationOneProblem.png alt="Maximum One Problem"></p><h2 id=添加额外的语言功能>添加额外的语言功能<a hidden class=anchor aria-hidden=true href=#添加额外的语言功能>#</a></h2><p>语言服务器通常实现的第一个有趣的功能是文件的验证。在这个意义上，即使是 linter 也算作一个语言服务器，在 VS Code 中，linter 通常被实现为语言服务器（见 eslint 和 jshint 的例子）。但语言服务器还有更多的作用。它们可以提供代码补全、查找所有引用、或转到定义。下面的示例代码将代码补全添加到服务器中。它提出了 &ldquo;TypeScript &ldquo;和 &ldquo;JavaScript &ldquo;两个词。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-35>35</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#75715e>// This handler provides the initial list of the completion items.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onCompletion</span>(
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>_textDocumentPosition</span>: <span style=color:#66d9ef>TextDocumentPositionParams</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>CompletionItem</span>[] <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The pass parameter contains the position of the text document in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// which code complete got requested. For the example we ignore this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// info and always provide the same completion items.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>label</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TypeScript&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kind</span>: <span style=color:#66d9ef>CompletionItemKind.Text</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>1</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>label</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;JavaScript&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kind</span>: <span style=color:#66d9ef>CompletionItemKind.Text</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>2</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// This handler resolves additional information for the item selected in
</span></span></span><span style=display:flex><span><span style=color:#75715e>// the completion list.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onCompletionResolve</span>(
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>item</span>: <span style=color:#66d9ef>CompletionItem</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>CompletionItem</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>data</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>detail</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TypeScript details&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>documentation</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TypeScript documentation&#39;</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>data</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>detail</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;JavaScript details&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>documentation</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;JavaScript documentation&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>item</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>);
</span></span></code></pre></td></tr></table></div></div><p>数据字段被用来唯一地识别解析处理程序中的完成项目。数据属性对协议来说是透明的。因为底层的消息传递协议是基于 JSON 的，所以数据字段应该只持有可序列化为 JSON 的数据。</p><p>所缺少的就是告诉 VS Code 服务器支持代码完成请求。要做到这一点，在初始化处理程序中标记相应的能力:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-12>12</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onInitialize</span>((<span style=color:#a6e22e>params</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>InitializeResult</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>capabilities</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Tell the client that the server supports code completion
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>completionProvider</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>resolveProvider</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>});
</span></span></code></pre></td></tr></table></div></div><p>下面的截图显示了在一个纯文本文件上运行的完整代码:</p><p><img loading=lazy src=https://code.visualstudio.com/assets/api/language-extensions/language-server-extension-guide/codeComplete.png alt="Code Complete"></p><h2 id=测试语言服务器>测试语言服务器<a hidden class=anchor aria-hidden=true href=#测试语言服务器>#</a></h2><p>为了创建一个高质量的语言服务器，我们需要建立一个涵盖其功能的良好测试套件。有两种常见的测试语言服务器的方法。</p><ul><li><p>单元测试。如果你想通过模拟所有被发送到语言服务器的信息来测试语言服务器的特定功能，这很有用。VS Code 的 HTML / CSS / JSON 语言服务器采取这种测试方法。LSP 的 npm 模块也使用这种方法。请看这里，使用 npm 协议模块写的一些单元测试。</p></li><li><p>端到端测试。这类似于 VS Code 的扩展测试。这种方法的好处是，它通过实例化 VS Code 实例与工作区，打开文件，激活语言客户端/服务器，并运行 VS Code 命令来运行测试。如果你有很难或不可能模拟的文件、设置或依赖关系（如 node_modules），这种方法就很优越。流行的 Python 扩展就采用这种方法进行测试。</p></li></ul><p>在你选择的任何测试框架中都有可能做单元测试。这里我们描述如何对语言服务器扩展做端到端的测试。</p><p>打开<code>.vscode/launch.json</code>，你可以找到一个 E2E 测试目标:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-12>12</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Language Server E2E Test&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;extensionHost&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;request&#34;</span>: <span style=color:#e6db74>&#34;launch&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;runtimeExecutable&#34;</span>: <span style=color:#e6db74>&#34;${execPath}&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;args&#34;</span>: [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;--extensionDevelopmentPath=${workspaceRoot}&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;--extensionTestsPath=${workspaceRoot}/client/out/test/index&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;${workspaceRoot}/client/testFixture&#34;</span>
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;outFiles&#34;</span>: [<span style=color:#e6db74>&#34;${workspaceRoot}/client/out/test/**/*.js&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>如果你运行这个调试目标，它将启动一个 VS Code 实例，将 <code>client/testFixture</code> 作为活动工作空间。然后，VS Code 将继续执行客户端<code>/src/test</code> 中的所有测试。作为一个调试提示，你可以在客户端<code>/src/test</code> 中的 TypeScript 文件中设置断点，它们会被击中。</p><p>让我们看一下 completion.test.ts 文件:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-27>27</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-28>28</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-29>29</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-30>30</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-31>31</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-32>32</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-33>33</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-34>34</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-35>35</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-36>36</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-37>37</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-38>38</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>vscode</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;vscode&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>assert</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;assert&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>getDocUri</span>, <span style=color:#a6e22e>activate</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./helper&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>suite</span>(<span style=color:#e6db74>&#39;Should do completion&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>docUri</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getDocUri</span>(<span style=color:#e6db74>&#39;completion.txt&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>test</span>(<span style=color:#e6db74>&#39;Completes JS/TS in txt file&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>testCompletion</span>(<span style=color:#a6e22e>docUri</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>vscode</span>.<span style=color:#a6e22e>Position</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>), {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>items</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>label</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;JavaScript&#39;</span>, <span style=color:#a6e22e>kind</span>: <span style=color:#66d9ef>vscode.CompletionItemKind.Text</span> },
</span></span><span style=display:flex><span>        { <span style=color:#a6e22e>label</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TypeScript&#39;</span>, <span style=color:#a6e22e>kind</span>: <span style=color:#66d9ef>vscode.CompletionItemKind.Text</span> }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>testCompletion</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>docUri</span>: <span style=color:#66d9ef>vscode.Uri</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>position</span>: <span style=color:#66d9ef>vscode.Position</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expectedCompletionList</span>: <span style=color:#66d9ef>vscode.CompletionList</span>
</span></span><span style=display:flex><span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>activate</span>(<span style=color:#a6e22e>docUri</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Executing the command `vscode.executeCompletionItemProvider` to simulate triggering completion
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>actualCompletionList</span> <span style=color:#f92672>=</span> (<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>vscode</span>.<span style=color:#a6e22e>commands</span>.<span style=color:#a6e22e>executeCommand</span>(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;vscode.executeCompletionItemProvider&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>docUri</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>position</span>
</span></span><span style=display:flex><span>  )) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>vscode</span>.<span style=color:#a6e22e>CompletionList</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>ok</span>(<span style=color:#a6e22e>actualCompletionList</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expectedCompletionList</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>expectedItem</span>, <span style=color:#a6e22e>i</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>actualItem</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>actualCompletionList</span>.<span style=color:#a6e22e>items</span>[<span style=color:#a6e22e>i</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>actualItem</span>.<span style=color:#a6e22e>label</span>, <span style=color:#a6e22e>expectedItem</span>.<span style=color:#a6e22e>label</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>actualItem</span>.<span style=color:#a6e22e>kind</span>, <span style=color:#a6e22e>expectedItem</span>.<span style=color:#a6e22e>kind</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在这个测试中，我们:</p><ul><li><p>激活扩展。</p></li><li><p>运行命令 <code>vscode.executeCompletionItemProvider</code>，用一个 URI 和一个位置来模拟完成触发。</p></li><li><p>将返回的完成项目与我们预期的完成项目进行对比，进行断言。
让我们更深入地研究激活(docURI)函数。</p></li></ul><p>它被定义在 <code>client/src/test/helper.ts</code> 中:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-26>26</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>vscode</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;vscode&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>path</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;path&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>doc</span>: <span style=color:#66d9ef>vscode.TextDocument</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>editor</span>: <span style=color:#66d9ef>vscode.TextEditor</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>documentEol</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>platformEol</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Activates the vscode.lsp-sample extension
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>activate</span>(<span style=color:#a6e22e>docUri</span>: <span style=color:#66d9ef>vscode.Uri</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// The extensionId is `publisher.name` from package.json
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ext</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>vscode</span>.<span style=color:#a6e22e>extensions</span>.<span style=color:#a6e22e>getExtension</span>(<span style=color:#e6db74>&#39;vscode-samples.lsp-sample&#39;</span>)<span style=color:#f92672>!</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>ext</span>.<span style=color:#a6e22e>activate</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>doc</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>vscode</span>.<span style=color:#a6e22e>workspace</span>.<span style=color:#a6e22e>openTextDocument</span>(<span style=color:#a6e22e>docUri</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>editor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>vscode</span>.window.<span style=color:#a6e22e>showTextDocument</span>(<span style=color:#a6e22e>doc</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>sleep</span>(<span style=color:#ae81ff>2000</span>); <span style=color:#75715e>// Wait for server activation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#a6e22e>e</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>sleep</span>(<span style=color:#a6e22e>ms</span>: <span style=color:#66d9ef>number</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>(<span style=color:#a6e22e>resolve</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>ms</span>));
</span></span></code></pre></td></tr></table></div></div><p>在激活的部分：</p><ul><li><p>使用 package.json 中定义的<code>{publisher.name}.{extensionId}</code>获取扩展。</p></li><li><p>打开指定的文档，并在活动的文本编辑器中显示它。</p></li><li><p>睡眠 2 秒，这样我们就能确定语言服务器已经被实例化了。</p></li></ul><p>准备工作完成后，我们可以运行与每个语言特性相对应的 VS 代码命令，并对返回的结果进行断言。</p><p>还有一个测试，涵盖了我们刚刚实现的诊断功能。请看 <code>client/src/test/diagnostics.test.ts</code>。</p><h1 id=高级主题>高级主题<a hidden class=anchor aria-hidden=true href=#高级主题>#</a></h1><p>到目前为止，本指南涵盖了。</p><ul><li><p>语言服务器和语言服务器协议的简要概述。</p></li><li><p>VS 代码中的语言服务器扩展的架构</p></li><li><p>lsp-sample 扩展，以及如何开发/调试/检查/测试它。</p></li></ul><p>有一些更高级的主题我们无法装入本指南中。我们将包括这些资源的链接，以便进一步研究语言服务器的开发。</p><h2 id=额外的语言服务器功能>额外的语言服务器功能<a hidden class=anchor aria-hidden=true href=#额外的语言服务器功能>#</a></h2><p>目前在语言服务器中，与代码补全一起支持下列语言功能。</p><ul><li>文档高亮：高亮显示一个文本文档中的所有 &ldquo;相等 &ldquo;符号。</li><li>悬停：为在文本文档中选择的符号提供悬停信息。</li><li>签名帮助：为文本文件中选定的符号提供签名帮助。</li><li>转到定义：为在文本文档中选择的符号提供转到定义的支持。</li><li>转到类型定义：为在文本文档中选择的符号提供转到类型/界面定义支持。</li><li>转到实现：为在文本文档中选择的符号提供转到实现定义的支持。</li><li>查找引用：为在文本文档中选择的符号查找所有项目范围内的引用。</li><li>List Document Symbols: 列出文本文档中定义的所有符号。</li><li>列出工作区符号：列出所有项目范围内的符号。</li><li>Code Actions：计算要对一个给定的文本文档和范围运行的命令（通常是美化/重构）。</li><li>CodeLens：为一个给定的文本文档计算 CodeLens 的统计数据。</li><li>文档格式化：这包括整个文档的格式化，文档范围和类型的格式化。</li><li>重命名：在项目范围内重命名一个符号。</li><li>文档链接：计算和解决一个文档内的链接。</li><li>文档颜色：计算和解析文档中的颜色，以便在编辑器中提供颜色选择器。</li></ul><p>程序性语言功能主题描述了上述每个语言功能，并提供了如何通过语言服务器协议或直接从你的扩展中使用扩展性 API 来实现它们的指导。</p><h2 id=增量式文本文件同步>增量式文本文件同步<a hidden class=anchor aria-hidden=true href=#增量式文本文件同步>#</a></h2><p>这个例子使用 vscode-languageserver 模块提供的简单文本文档管理器来同步 VS Code 和语言服务器之间的文档。</p><p>这有两个缺点：</p><ul><li>大量的数据被传输，因为整个文本文档的内容被重复地发送到服务器上。</li><li>如果使用现有的语言库，这种库通常支持增量的文档更新，以避免不必要的解析和抽象语法树的创建。</li></ul><p>因此，该协议也支持增量文档同步。</p><p>为了利用增量文档同步，服务器需要安装三个通知处理程序。</p><ul><li>onDidOpenTextDocument：当 VS Code 中打开一个文本文档时被调用。</li><li>onDidChangeTextDocument：当 VS Code 中的文本文档的内容发生变化时被调用。</li><li>onDidCloseTextDocument: 在 VS Code 中当一个文本文档被关闭时被调用。</li></ul><p>下面是一个代码片段，说明了如何在一个连接上钩住这些通知处理程序，以及如何在初始化时返回正确的能力。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1> 1</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-2> 2</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-3> 3</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-4> 4</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-5> 5</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-6> 6</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-7> 7</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-8> 8</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-9> 9</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-10>10</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-11>11</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-12>12</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-13>13</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-14>14</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-15>15</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-16>16</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-17>17</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-18>18</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-19>19</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-20>20</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-21>21</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-22>22</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-23>23</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-24>24</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-25>25</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-26>26</a>
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-27>27</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onInitialize</span>((<span style=color:#a6e22e>params</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>InitializeResult</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>capabilities</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Enable incremental document sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>textDocumentSync</span>: <span style=color:#66d9ef>TextDocumentSyncKind.Incremental</span>,
</span></span><span style=display:flex><span>            ...
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onDidOpenTextDocument</span>((<span style=color:#a6e22e>params</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// A text document was opened in VS Code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// params.uri uniquely identifies the document. For documents stored on disk, this is a file URI.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// params.text the initial full content of the document.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onDidChangeTextDocument</span>((<span style=color:#a6e22e>params</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The content of a text document has change in VS Code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// params.uri uniquely identifies the document.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// params.contentChanges describe the content changes to the document.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>onDidCloseTextDocument</span>((<span style=color:#a6e22e>params</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// A text document was closed in VS Code.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// params.uri uniquely identifies the document.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>});
</span></span></code></pre></td></tr></table></div></div><h2 id=直接使用-vs-code-api-来实现语言功能>直接使用 VS Code API 来实现语言功能<a hidden class=anchor aria-hidden=true href=#直接使用-vs-code-api-来实现语言功能>#</a></h2><p>虽然语言服务器有很多好处，但它们不是扩展 VS Code 编辑能力的唯一选择。在你想为一种类型的文档添加一些简单的语言功能的情况下，可以考虑使用 <code>vscode.languages.register[LANGUAGE_FEATURE]Provider</code> 作为一种选择。</p><p>下面是一个使用 <code>vscode.languages.registerCompletionItemProvider</code> 为纯文本文件添加一些片段作为补语的例子。</p><p>更多说明 VS Code API 用法的例子可以在<a href=https://github.com/microsoft/vscode-extension-samples>https://github.com/microsoft/vscode-extension-samples</a>。</p><h2 id=语言服务器的容错解析器>语言服务器的容错解析器<a hidden class=anchor aria-hidden=true href=#语言服务器的容错解析器>#</a></h2><p>大多数时候，编辑器中的代码是不完整的，语法上也是不正确的，但开发人员仍然希望自动完成和其他语言功能能够工作。因此，对于语言服务器来说，一个容错的解析器是必要的。解析器从部分完整的代码中生成有意义的 AST，而语言服务器则根据 AST 提供语言功能。</p><p>当我们在 VS Code 中改进对 PHP 的支持时，我们意识到官方的 PHP 解析器不是容错的，不能直接在语言服务器中重复使用。因此，我们在 Microsoft/tolerant-php-parser 上做了工作，并留下了详细的注释，这可能有助于需要实现容错解析器的语言服务器作者。</p><h1 id=常见的问题>常见的问题<a hidden class=anchor aria-hidden=true href=#常见的问题>#</a></h1><p>当我试图连接到服务器时，我得到 &ldquo;无法连接到运行时进程（5000ms 后超时）"？</p><p>如果在你尝试连接调试器时，服务器没有运行，你会看到这个超时错误。客户端会启动语言服务器，所以要确保你已经启动了客户端，以便有一个正在运行的服务器。如果你的客户端断点干扰了服务器的启动，你可能还需要禁用你的客户端断点。</p><p>我已经读完了本指南和 LSP 规范，但我仍有一些问题没有解决。我在哪里可以得到帮助？</p><p>请在<a href=https://github.com/microsoft/language-server-protocol>https://github.com/microsoft/language-server-protocol</a> 上开一个问题。</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://zhenfeng-zhu.github.io/post/crystal-1.4.0/><span class=title>Next Page »</span><br><span>Crystal 1.4.0</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Lsp Intro on twitter" href="https://twitter.com/intent/tweet/?text=Lsp%20Intro&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fpost%2flsp-intro%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lsp Intro on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fpost%2flsp-intro%2f&title=Lsp%20Intro&summary=Lsp%20Intro&source=https%3a%2f%2fzhenfeng-zhu.github.io%2fpost%2flsp-intro%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lsp Intro on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fzhenfeng-zhu.github.io%2fpost%2flsp-intro%2f&title=Lsp%20Intro"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lsp Intro on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fzhenfeng-zhu.github.io%2fpost%2flsp-intro%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lsp Intro on whatsapp" href="https://api.whatsapp.com/send?text=Lsp%20Intro%20-%20https%3a%2f%2fzhenfeng-zhu.github.io%2fpost%2flsp-intro%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Lsp Intro on telegram" href="https://telegram.me/share/url?text=Lsp%20Intro&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fpost%2flsp-intro%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=zhenfeng-zhu/zhenfeng-zhu.github.io issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://zhenfeng-zhu.github.io>Awesome Fenix</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>