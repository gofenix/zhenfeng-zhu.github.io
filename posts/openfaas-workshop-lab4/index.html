<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>openfaas-workshop-lab4 | Go Data</title>
<meta name=keywords content>
<meta name=description content="Lab 4 - 深入函数 在开始本实验之前，创建一个新的文件夹，把 lab3 的文件拷贝到 lab4 里：
$ cp -r lab3 lab4 \ && cd lab4 通过环境变量注入配置 It is useful to be able to control how a function behaves at runtime, we can do that in at least two ways:
控制函数在运行时的行为很有用，我们至少可以通过两种方式来实现：
在部署时  在部署时设置环境变量  我们在 Lab3 时用了 write_debug 来做——你也可以在这里设置你想要的任何自定义的环境变量。例如：如果你想为 hello world 函数配置一种语言，可以引入一个 spoken_language 变量。
使用 HTTP 上下文——querystring / headers  使用 querystring 和 HTTP headers  另一个更为动态的选项是可以在每个请求级别上进行修改，即使用 querystrings 和 HTTP headers，这两者都可以通过 faas-cli 或者 curl 传递。">
<meta name=author content="Lucas">
<link rel=canonical href=https://zhenfeng-zhu.github.io/posts/openfaas-workshop-lab4/>
<link href=/assets/css/stylesheet.min.8d754ccb970fef4a6d8e5b0441e01d76a0d3530c6777067a1b2ca581aa1b4af7.css integrity="sha256-jXVMy5cP70ptjlsEQeAddqDTUwxndwZ6GyylgaobSvc=" rel="preload stylesheet" as=style>
<link rel=icon href=https://zhenfeng-zhu.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://zhenfeng-zhu.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://zhenfeng-zhu.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://zhenfeng-zhu.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://zhenfeng-zhu.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<meta property="og:title" content="openfaas-workshop-lab4">
<meta property="og:description" content="Lab 4 - 深入函数 在开始本实验之前，创建一个新的文件夹，把 lab3 的文件拷贝到 lab4 里：
$ cp -r lab3 lab4 \ && cd lab4 通过环境变量注入配置 It is useful to be able to control how a function behaves at runtime, we can do that in at least two ways:
控制函数在运行时的行为很有用，我们至少可以通过两种方式来实现：
在部署时  在部署时设置环境变量  我们在 Lab3 时用了 write_debug 来做——你也可以在这里设置你想要的任何自定义的环境变量。例如：如果你想为 hello world 函数配置一种语言，可以引入一个 spoken_language 变量。
使用 HTTP 上下文——querystring / headers  使用 querystring 和 HTTP headers  另一个更为动态的选项是可以在每个请求级别上进行修改，即使用 querystrings 和 HTTP headers，这两者都可以通过 faas-cli 或者 curl 传递。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://zhenfeng-zhu.github.io/posts/openfaas-workshop-lab4/">
<meta property="og:image" content="https://zhenfeng-zhu.github.io/papermod-cover.png">
<meta property="article:published_time" content="2018-07-02T09:32:59+00:00">
<meta property="article:modified_time" content="2018-07-02T09:32:59+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://zhenfeng-zhu.github.io/papermod-cover.png">
<meta name=twitter:title content="openfaas-workshop-lab4">
<meta name=twitter:description content="Lab 4 - 深入函数 在开始本实验之前，创建一个新的文件夹，把 lab3 的文件拷贝到 lab4 里：
$ cp -r lab3 lab4 \ && cd lab4 通过环境变量注入配置 It is useful to be able to control how a function behaves at runtime, we can do that in at least two ways:
控制函数在运行时的行为很有用，我们至少可以通过两种方式来实现：
在部署时  在部署时设置环境变量  我们在 Lab3 时用了 write_debug 来做——你也可以在这里设置你想要的任何自定义的环境变量。例如：如果你想为 hello world 函数配置一种语言，可以引入一个 spoken_language 变量。
使用 HTTP 上下文——querystring / headers  使用 querystring 和 HTTP headers  另一个更为动态的选项是可以在每个请求级别上进行修改，即使用 querystrings 和 HTTP headers，这两者都可以通过 faas-cli 或者 curl 传递。">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://zhenfeng-zhu.github.io/posts/"},{"@type":"ListItem","position":3,"name":"openfaas-workshop-lab4","item":"https://zhenfeng-zhu.github.io/posts/openfaas-workshop-lab4/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"openfaas-workshop-lab4","name":"openfaas-workshop-lab4","description":"Lab 4 - 深入函数 在开始本实验之前，创建一个新的文件夹，把 lab3 的文件拷贝到 lab4 里：\n$ cp -r lab3 lab4 \\ \u0026amp;amp;\u0026amp;amp; cd lab4 通过环境变量注入配置 It is useful to be able to control how a function behaves at runtime, we can …","keywords":[],"articleBody":"Lab 4 - 深入函数 在开始本实验之前，创建一个新的文件夹，把 lab3 的文件拷贝到 lab4 里：\n$ cp -r lab3 lab4 \\ \u0026\u0026 cd lab4 通过环境变量注入配置 It is useful to be able to control how a function behaves at runtime, we can do that in at least two ways:\n控制函数在运行时的行为很有用，我们至少可以通过两种方式来实现：\n在部署时  在部署时设置环境变量  我们在 Lab3 时用了 write_debug 来做——你也可以在这里设置你想要的任何自定义的环境变量。例如：如果你想为 hello world 函数配置一种语言，可以引入一个 spoken_language 变量。\n使用 HTTP 上下文——querystring / headers  使用 querystring 和 HTTP headers  另一个更为动态的选项是可以在每个请求级别上进行修改，即使用 querystrings 和 HTTP headers，这两者都可以通过 faas-cli 或者 curl 传递。\n这些 headers 通过环境变量暴露出来，因此你可以很容易的在函数中使用。所有的 header 都以 Http*为前缀，并且所有的-都被替换为了*下划线\n让我们用一个 querystring 和一个列出所有环境变量的函数来尝试一下：\n 部署一个函数，此函数使用内置的 BusyBox 命令来打印环境变量  $ faas-cli deploy --name env --fprocess=\"env\" --image=\"functions/alpine:latest\" --network=func_functions  用一个 querystring 去调用函数：  $ echo \"\" | faas-cli invoke env --query workshop=1 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin HOSTNAME=05e8db360c5a fprocess=env HOME=/root Http_Connection=close Http_Content_Type=text/plain Http_X_Call_Id=cdbed396-a20a-43fe-9123-1d5a122c976d Http_X_Forwarded_For=10.255.0.2 Http_X_Start_Time=1519729562486546741 Http_User_Agent=Go-http-client/1.1 Http_Accept_Encoding=gzip Http_Method=POST Http_ContentLength=-1 Http_Path=/function/env ... Http_Query=workshop=1 ... 在 python 代码中，你应该输入 os.getenv(“Http_Query”)\n 现在用一个 header 调用函数：  $ echo \"\" | curl http://127.0.0.1:8080/function/env --header \"X-Output-Mode: json\" PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin HOSTNAME=05e8db360c5a fprocess=env HOME=/root Http_X_Call_Id=8e597bcf-614f-4ca5-8f2e-f345d660db5e Http_X_Forwarded_For=10.255.0.2 Http_X_Start_Time=1519729577415481886 Http_Accept=*/* Http_Accept_Encoding=gzip Http_Connection=close Http_User_Agent=curl/7.55.1 Http_Method=GET Http_ContentLength=0 Http_Path=/function/env ... Http_X_Output_Mode=json ... 在 python 代码中，你应该输入 os.getenv(“Http_X_Outout_Mode”)。\n你可以看到，当 Http_Method 是 POST 方法时， 所有的其他 HTTP 上下文也被提供了出来，比如 Content-Length，User_Agent， Cookies 和其他 HTTP 请求中应有的参数。\n利用日志 OpenFaaS 的 watchdog 是通过标准 IO 流的 stdin 和 stdout 处理 HTTP 请求和读取 HTTP 响应。这意味着作为一个函数的进程不需要知道任何 web 和 HTTP 的信息。\n一个有趣的情况是当函数以非零的退出且 stderr 不为空。默认情况下，函数的 stdout/stderr 被合并了，且 stderr 不会被打印到日志里。\n让我们使用 Lab3 的函数 hello-openfaas 验证一下。\n修改 handler.py 为：\nimport sys import json def handle(req): sys.stderr.write(\"This should be an error message.\\n\") return json.dumps({\"Hello\": \"OpenFaaS\"}) 构建并部署：\n$ faas-cli build -f hello-openfaas.yml \\  \u0026\u0026 faas-cli push -f hello-openfaas.yml \\  \u0026\u0026 faas-cli deploy -f hello-openfaas.yml 然后调用函数：\n$ echo | faas-cli invoke hello-openfaas 你应该可以看到合并之后的输出：\nThis should be an error message. {\"Hello\": \"OpenFaaS\"}  说明：如果使用docker service logs hello-openfaas检查容器的日志，你应该看不到 stderr 输出。\n 在这个例子中，我们需要函数返回一个可被解析的合法 JSON。不幸的是日志信息使得输出不可用，所以我们需要重定向 stderr 的信息到容器的日志中。OpenFaaS 提供了一个解决方案即：只返回 stdout，因此你可以打印日志的错误信息并且保证函数的返回是清晰的。\n为了达到目的，你应该使用combine_output参数：\n让我们尝试一下。打开hello-openfaas.yaml文件，然后添加下面这几行：\nenvironment: combine_output: false 推送部署并调用函数。\n输出应该是：\n{\"Hello\": \"OpenFaaS\"} 检查容易的 stderr 日志。你应该可以看到如下类似的消息：\nhello-openfaas.1.2xtrr2ckkkth@linuxkit-025000000001 | 2018/04/03 08:35:24 stderr: This should be an error message. 创建工作流程 在某些情况下，将一个函数的输出作为另一个函数的输入是很有用的。通过客户端或者 API 网关都可以实现。\n在客户端的函数链 你可以使用 curl，faas-cli 或者你自己的其他代码将一个函数的结果传给另一个函数。这是一个例子：\n优点：\n requires no code - can be done with CLI programs 无需代码——可以使用 CLI 程序完成 fast for development and testing 快速开发测试 easy to model in code 易于在代码中建模  缺点：\n additional latency - each function goes back to the server 额外的延迟——每个函数都要返回到服务器 chatty (more messages) 繁琐（更多的消息）  例子：\n  从函数商店中部署一个 Nodeinfo 函数\n  把 NodeInfo 的输出传给 Markdown。\n  $ echo -n \"\" | faas-cli invoke nodeinfo | faas-cli invoke func_markdown Hostname: 64767782518c\nPlatform: linux Arch: x64 CPU count: 4 Uptime: 1121466\n你现在将会看到 NodeInfo 函数的输出被 HTML 标签装饰了。\n客户端函数链的另一个例子是生成一个图片，然后把它传给另一个加水印的函数。\n从一个函数中调用另一个函数 最简单的函数间调用是通过 OpenFaaS 的 API 网关做一个 HTTP 调用。这个调用是不用知道外部域名或 IP 地址，他可以简单通过 DNS 条目把 API 网关作为一个 gateway。\n在一个函数中访问 API 网关服务时，最好使用环境变量来配置主机名，这是很重要的，原因有两个——名字可能会改变，并且在 Kubernetes 中有时需要后缀\n优点：\n  函数可以直接使用对方\n  因为是在同一网络中互相访问，延迟较低\n  缺点：\n 需要一个 HTTP 请求的库  例子：\n在 Lab3 中，我们介绍了 requests 包并且使用它去调用 ISS 获取一个宇航员的名字。我们可以使用相同的技术调用部署在 OpenFaaS 中的其他函数。\n 打开函数商店然后部署Sentiment Analysis函数。  Sentiment Analysis 函数将会告诉你任意一个句子的主动性和倾向（积极性评级）。这个函数的结果是一个格式化的 JSON，如下面例子所示：\n$ echo -n \"California is great, it's always sunny there.\" | faas-cli invoke sentimentanalysis {\"polarity\": 0.8, \"sentence_count\": 1, \"subjectivity\": 0.75} 这个结果显示我们的测试句子非常有主动性（75%）且很积极（80%）。这两个字段的值在-1.00 和 1.00 之间。\n下面的代码被用于在任何一个函数中调用 Sentiment Analysis函数：\n test_sentence = \"California is great, it's always sunny there.\" r = requests.get(\"http://gateway:8080/function/sentimentanalysis\", text= test_sentence) 或者通过一个环境变量：\n gateway_hostname = os.getenv(\"gateway_hostname\", \"gateway\") # uses a default of \"gateway\" for when \"gateway_hostname\" is not set test_sentence = \"California is great, it's always sunny there.\" r = requests.get(\"http://\" + gateway_hostname + \":8080/function/sentimentanalysis\", text= test_sentence) 因为结果总是 JSON 格式的，所示我们可以使用.json()转化响应。\n result = r.json() if result[\"polarity\"]  0.45: return \"That was probably positive\" else: return \"That was neutral or negative\" 现在创建一个 Python 函数，然后合并在一起：\nimport os import requests import sys def handle(req): \"\"\"handle a request to the function Args: req (str): request body \"\"\" gateway_hostname = os.getenv(\"gateway_hostname\", \"gateway\") # uses a default of \"gateway\" for when \"gateway_hostname\" is not set test_sentence = req r = requests.get(\"http://\" + gateway_hostname + \":8080/function/sentimentanalysis\", data= test_sentence) if r.status_code != 200: sys.exit(\"Error with sentimentanalysis, expected: %d, got: %d\\n\" % (200, r.status_code)) result = r.json() if result[\"polarity\"]  0.45: return \"That was probably positive\" else: return \"That was neutral or negative\"  记得把 requests 添加到 requirements.txt 文件里  说明：你不需要修改 SentimentAnalysis 函数的源码，我们已经把它部署了，可以通过 API 网关获取。\n现在进入 Lab 5。\n","wordCount":"616","inLanguage":"en","datePublished":"2018-07-02T09:32:59Z","dateModified":"2018-07-02T09:32:59Z","author":{"@type":"Person","name":"Lucas"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhenfeng-zhu.github.io/posts/openfaas-workshop-lab4/"},"publisher":{"@type":"Organization","name":"Go Data","logo":{"@type":"ImageObject","url":"https://zhenfeng-zhu.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://zhenfeng-zhu.github.io accesskey=h title="Go Data (Alt + H)">Go Data</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu onscroll=menu_on_scroll()>
<li>
<a href=https://zhenfeng-zhu.github.io/about title=About>
<span>About</span>
</a>
</li>
<li>
<a href=https://zhenfeng-zhu.github.io/search/ title=🔍>
<span>🔍</span>
</a>
</li></ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs>
<a href=https://zhenfeng-zhu.github.io>Home</a>&nbsp;»&nbsp;<a href=https://zhenfeng-zhu.github.io/posts/>Posts</a>
</div>
<h1 class=post-title>
openfaas-workshop-lab4
</h1>
<div class=post-meta>
July 2, 2018&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Lucas
</div>
</header>
<div class=post-content>
<h1 id=lab-4---深入函数>Lab 4 - 深入函数<a hidden class=anchor aria-hidden=true href=#lab-4---深入函数>#</a></h1>
<p></p>
<p>在开始本实验之前，创建一个新的文件夹，把 lab3 的文件拷贝到 lab4 里：</p>
<pre tabindex=0><code>$ cp -r lab3 lab4 \
   &amp;&amp; cd lab4
</code></pre><h2 id=通过环境变量注入配置>通过环境变量注入配置<a hidden class=anchor aria-hidden=true href=#通过环境变量注入配置>#</a></h2>
<p>It is useful to be able to control how a function behaves at runtime, we can do that in at least two ways:</p>
<p>控制函数在运行时的行为很有用，我们至少可以通过两种方式来实现：</p>
<h3 id=在部署时>在部署时<a hidden class=anchor aria-hidden=true href=#在部署时>#</a></h3>
<ul>
<li>在部署时设置环境变量</li>
</ul>
<p>我们在 Lab3 时用了 write_debug 来做——你也可以在这里设置你想要的任何自定义的环境变量。例如：如果你想为 hello world 函数配置一种语言，可以引入一个 spoken_language 变量。</p>
<h3 id=使用-http-上下文querystring--headers>使用 HTTP 上下文——querystring / headers<a hidden class=anchor aria-hidden=true href=#使用-http-上下文querystring--headers>#</a></h3>
<ul>
<li>使用 querystring 和 HTTP headers</li>
</ul>
<p>另一个更为动态的选项是可以在每个请求级别上进行修改，即使用 querystrings 和 HTTP headers，这两者都可以通过 faas-cli 或者 curl 传递。</p>
<p>这些 headers 通过环境变量暴露出来，因此你可以很容易的在函数中使用。所有的 header 都以 Http*为前缀，并且所有的<code>-</code>都被替换为了<code>*</code>下划线</p>
<p>让我们用一个 querystring 和一个列出所有环境变量的函数来尝试一下：</p>
<ul>
<li>部署一个函数，此函数使用内置的 BusyBox 命令来打印环境变量</li>
</ul>
<pre tabindex=0><code>$ faas-cli deploy --name env --fprocess=&quot;env&quot; --image=&quot;functions/alpine:latest&quot; --network=func_functions
</code></pre><ul>
<li>用一个 querystring 去调用函数：</li>
</ul>
<pre tabindex=0><code>$ echo &quot;&quot; | faas-cli invoke env --query workshop=1
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=05e8db360c5a
fprocess=env
HOME=/root
Http_Connection=close
Http_Content_Type=text/plain
Http_X_Call_Id=cdbed396-a20a-43fe-9123-1d5a122c976d
Http_X_Forwarded_For=10.255.0.2
Http_X_Start_Time=1519729562486546741
Http_User_Agent=Go-http-client/1.1
Http_Accept_Encoding=gzip
Http_Method=POST
Http_ContentLength=-1
Http_Path=/function/env
...
Http_Query=workshop=1
...
</code></pre><p>在 python 代码中，你应该输入 os.getenv(&ldquo;Http_Query&rdquo;)</p>
<ul>
<li>现在用一个 header 调用函数：</li>
</ul>
<pre tabindex=0><code>$ echo &quot;&quot; | curl http://127.0.0.1:8080/function/env --header &quot;X-Output-Mode: json&quot;
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=05e8db360c5a
fprocess=env
HOME=/root
Http_X_Call_Id=8e597bcf-614f-4ca5-8f2e-f345d660db5e
Http_X_Forwarded_For=10.255.0.2
Http_X_Start_Time=1519729577415481886
Http_Accept=*/*
Http_Accept_Encoding=gzip
Http_Connection=close
Http_User_Agent=curl/7.55.1
Http_Method=GET
Http_ContentLength=0
Http_Path=/function/env
...
Http_X_Output_Mode=json
...
</code></pre><p>在 python 代码中，你应该输入 os.getenv(&ldquo;Http_X_Outout_Mode&rdquo;)。</p>
<p>你可以看到，当 Http_Method 是 POST 方法时， 所有的其他 HTTP 上下文也被提供了出来，比如 Content-Length，<code>User_Agent</code>， Cookies 和其他 HTTP 请求中应有的参数。</p>
<h2 id=利用日志>利用日志<a hidden class=anchor aria-hidden=true href=#利用日志>#</a></h2>
<p>OpenFaaS 的 watchdog 是通过标准 IO 流的 stdin 和 stdout 处理 HTTP 请求和读取 HTTP 响应。这意味着作为一个函数的进程不需要知道任何 web 和 HTTP 的信息。</p>
<p>一个有趣的情况是当函数以非零的退出且 stderr 不为空。默认情况下，函数的 stdout/stderr 被合并了，且 stderr 不会被打印到日志里。</p>
<p>让我们使用 Lab3 的函数 hello-openfaas 验证一下。</p>
<p>修改 handler.py 为：</p>
<pre tabindex=0><code>import sys
import json

def handle(req):

    sys.stderr.write(&quot;This should be an error message.\n&quot;)
    return json.dumps({&quot;Hello&quot;: &quot;OpenFaaS&quot;})
</code></pre><p>构建并部署：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ faas-cli build -f hello-openfaas.yml <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  <span style=color:#f92672>&amp;&amp;</span> faas-cli push -f hello-openfaas.yml <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  <span style=color:#f92672>&amp;&amp;</span> faas-cli deploy -f hello-openfaas.yml
</code></pre></div><p>然后调用函数：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ echo | faas-cli invoke hello-openfaas
</code></pre></div><p>你应该可以看到合并之后的输出：</p>
<pre tabindex=0><code>This should be an error message.
{&quot;Hello&quot;: &quot;OpenFaaS&quot;}
</code></pre><blockquote>
<p>说明：如果使用<code>docker service logs hello-openfaas</code>检查容器的日志，你应该看不到 stderr 输出。</p>
</blockquote>
<p>在这个例子中，我们需要函数返回一个可被解析的合法 JSON。不幸的是日志信息使得输出不可用，所以我们需要重定向 stderr 的信息到容器的日志中。OpenFaaS 提供了一个解决方案即：只返回 stdout，因此你可以打印日志的错误信息并且保证函数的返回是清晰的。</p>
<p>为了达到目的，你应该使用<code>combine_output</code>参数：</p>
<p>让我们尝试一下。打开<code>hello-openfaas.yaml</code>文件，然后添加下面这几行：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    <span style=color:#f92672>environment</span>:
      <span style=color:#f92672>combine_output</span>: <span style=color:#66d9ef>false</span>
</code></pre></div><p>推送部署并调用函数。</p>
<p>输出应该是：</p>
<pre tabindex=0><code>{&quot;Hello&quot;: &quot;OpenFaaS&quot;}
</code></pre><p>检查容易的 stderr 日志。你应该可以看到如下类似的消息：</p>
<pre tabindex=0><code>hello-openfaas.1.2xtrr2ckkkth@linuxkit-025000000001    | 2018/04/03 08:35:24 stderr: This should be an error message.
</code></pre><h2 id=创建工作流程>创建工作流程<a hidden class=anchor aria-hidden=true href=#创建工作流程>#</a></h2>
<p>在某些情况下，将一个函数的输出作为另一个函数的输入是很有用的。通过客户端或者 API 网关都可以实现。</p>
<h3 id=在客户端的函数链>在客户端的函数链<a hidden class=anchor aria-hidden=true href=#在客户端的函数链>#</a></h3>
<p>你可以使用 curl，faas-cli 或者你自己的其他代码将一个函数的结果传给另一个函数。这是一个例子：</p>
<p>优点：</p>
<ul>
<li>requires no code - can be done with CLI programs</li>
<li>无需代码——可以使用 CLI 程序完成</li>
<li>fast for development and testing</li>
<li>快速开发测试</li>
<li>easy to model in code</li>
<li>易于在代码中建模</li>
</ul>
<p>缺点：</p>
<ul>
<li>additional latency - each function goes back to the server</li>
<li>额外的延迟——每个函数都要返回到服务器</li>
<li>chatty (more messages)</li>
<li>繁琐（更多的消息）</li>
</ul>
<p>例子：</p>
<ul>
<li>
<p>从函数商店中部署一个 Nodeinfo 函数</p>
</li>
<li>
<p>把 NodeInfo 的输出传给 Markdown。</p>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ echo -n <span style=color:#e6db74>&#34;&#34;</span> | faas-cli invoke nodeinfo | faas-cli invoke func_markdown
&lt;p&gt;Hostname: 64767782518c&lt;/p&gt;

&lt;p&gt;Platform: linux
Arch: x64
CPU count: <span style=color:#ae81ff>4</span>
Uptime: 1121466&lt;/p&gt;
</code></pre></div><p>你现在将会看到 NodeInfo 函数的输出被 HTML 标签装饰了。</p>
<p>客户端函数链的另一个例子是生成一个图片，然后把它传给另一个加水印的函数。</p>
<h3 id=从一个函数中调用另一个函数>从一个函数中调用另一个函数<a hidden class=anchor aria-hidden=true href=#从一个函数中调用另一个函数>#</a></h3>
<p>最简单的函数间调用是通过 OpenFaaS 的 API 网关做一个 HTTP 调用。这个调用是不用知道外部域名或 IP 地址，他可以简单通过 DNS 条目把 API 网关作为一个 gateway。</p>
<p>在一个函数中访问 API 网关服务时，最好使用环境变量来配置主机名，这是很重要的，原因有两个——名字可能会改变，并且在 Kubernetes 中有时需要后缀</p>
<p>优点：</p>
<ul>
<li>
<p>函数可以直接使用对方</p>
</li>
<li>
<p>因为是在同一网络中互相访问，延迟较低</p>
</li>
</ul>
<p>缺点：</p>
<ul>
<li>需要一个 HTTP 请求的库</li>
</ul>
<p>例子：</p>
<p>在 Lab3 中，我们介绍了 requests 包并且使用它去调用 ISS 获取一个宇航员的名字。我们可以使用相同的技术调用部署在 OpenFaaS 中的其他函数。</p>
<ul>
<li>打开函数商店然后部署<em>Sentiment Analysis</em>函数。</li>
</ul>
<p>Sentiment Analysis 函数将会告诉你任意一个句子的主动性和倾向（积极性评级）。这个函数的结果是一个格式化的 JSON，如下面例子所示：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ echo -n <span style=color:#e6db74>&#34;California is great, it&#39;s always sunny there.&#34;</span> | faas-cli invoke sentimentanalysis
<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;polarity&#34;</span>: 0.8, <span style=color:#e6db74>&#34;sentence_count&#34;</span>: 1, <span style=color:#e6db74>&#34;subjectivity&#34;</span>: 0.75<span style=color:#f92672>}</span>
</code></pre></div><p>这个结果显示我们的测试句子非常有主动性（75%）且很积极（80%）。这两个字段的值在-1.00 和 1.00 之间。</p>
<p>下面的代码被用于在任何一个函数中调用 <em>Sentiment Analysis</em>函数：</p>
<pre tabindex=0><code>    test_sentence = &quot;California is great, it's always sunny there.&quot;
    r = requests.get(&quot;http://gateway:8080/function/sentimentanalysis&quot;, text= test_sentence)
</code></pre><p>或者通过一个环境变量：</p>
<pre tabindex=0><code>    gateway_hostname = os.getenv(&quot;gateway_hostname&quot;, &quot;gateway&quot;) # uses a default of &quot;gateway&quot; for when &quot;gateway_hostname&quot; is not set
    test_sentence = &quot;California is great, it's always sunny there.&quot;
    r = requests.get(&quot;http://&quot; + gateway_hostname + &quot;:8080/function/sentimentanalysis&quot;, text= test_sentence)
</code></pre><p>因为结果总是 JSON 格式的，所示我们可以使用.json()转化响应。</p>
<pre tabindex=0><code>    result = r.json()
    if result[&quot;polarity&quot;] &gt; 0.45:
       return &quot;That was probably positive&quot;
    else:
        return &quot;That was neutral or negative&quot;
</code></pre><p>现在创建一个 Python 函数，然后合并在一起：</p>
<pre tabindex=0><code>import os
import requests
import sys

def handle(req):
    &quot;&quot;&quot;handle a request to the function
    Args:
        req (str): request body
    &quot;&quot;&quot;

    gateway_hostname = os.getenv(&quot;gateway_hostname&quot;, &quot;gateway&quot;) # uses a default of &quot;gateway&quot; for when &quot;gateway_hostname&quot; is not set

    test_sentence = req

    r = requests.get(&quot;http://&quot; + gateway_hostname + &quot;:8080/function/sentimentanalysis&quot;, data= test_sentence)

    if r.status_code != 200:
        sys.exit(&quot;Error with sentimentanalysis, expected: %d, got: %d\n&quot; % (200, r.status_code))

    result = r.json()
    if result[&quot;polarity&quot;] &gt; 0.45:
        return &quot;That was probably positive&quot;
    else:
        return &quot;That was neutral or negative&quot;
</code></pre><ul>
<li>记得把 requests 添加到 requirements.txt 文件里</li>
</ul>
<p>说明：你不需要修改 SentimentAnalysis 函数的源码，我们已经把它部署了，可以通过 API 网关获取。</p>
<p>现在进入 Lab 5。</p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://zhenfeng-zhu.github.io/posts/openfaas-on-rancher/>
<span class=title>« Prev Page</span>
<br>
<span>OpenFaaS on Rancher 2.0</span>
</a>
<a class=next href=https://zhenfeng-zhu.github.io/posts/ubuntu-docker-sudo/>
<span class=title>Next Page »</span>
<br>
<span>ubuntu-docker-sudo</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on twitter" href="https://twitter.com/intent/tweet/?text=openfaas-workshop-lab4&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f&title=openfaas-workshop-lab4&summary=openfaas-workshop-lab4&source=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f&title=openfaas-workshop-lab4"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on whatsapp" href="https://api.whatsapp.com/send?text=openfaas-workshop-lab4%20-%20https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on telegram" href="https://telegram.me/share/url?text=openfaas-workshop-lab4&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main><footer class=footer>
<span>&copy; 2021 <a href=https://zhenfeng-zhu.github.io>Go Data</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>