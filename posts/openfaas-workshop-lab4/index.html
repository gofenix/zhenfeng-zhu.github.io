<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>openfaas-workshop-lab4 | Awesome Fenix</title>
<meta name=keywords content>
<meta name=description content="实验 4&ndash;更深入地使用函数 在开始本实验之前，为你的文件创建一个新的文件夹。由于本实验是建立在早期实验的基础上的，所以请复制 lab3。
$ cp -r lab3 lab4\ && cd lab4 通过环境变量注入配置 能够控制一个函数在运行时的行为方式是很有用的，我们至少可以通过两种方式来实现这一点。
在部署时 *在部署时设置环境变量
我们在Lab 3中用write_debug做了这个 - 你也可以在这里设置任何你想要的自定义环境变量 - 例如，如果你想为你的hello world函数配置一种语言，你可以引入一个spoken_language变量。
使用 HTTP 上下文&ndash;querystring / headers *使用 querystring 和 HTTP headers
另一个更动态的、可以在每个请求层面上改变的选项是使用查询字符串和 HTTP 头信息，两者都可以通过faas-cli或curl传递。
这些头信息通过环境变量暴露出来，所以它们很容易在你的函数中被使用。所以任何头信息都以Http_为前缀，所有-连字符都被替换成_下划线。
让我们用 querystring 和一个列出所有环境变量的函数来试试。
 使用 BusyBox 的内置命令，部署一个打印环境变量的函数。  faas-cli deploy --name env --fprocess=&#34;env&#34; --image=&#34;function/alpine:latest&#34;  用一个查询字符串调用该函数。  $ echo &#34;&#34; | faas-cli invoke env --query workshop=1 PATH=/usr/local/bin:/usr/local/bin:/usr/bin:/sbin:/bin HOSTNAME=05e8db360c5a fprocess=env HOME=/root Http_Connection=close Http_Content_Type=text/plain Http_X_Call_Id=cdbed396-a20a-43fe-9123-1d5a122c976d Http_X_Forwarded_For=10.">
<meta name=author content="Fenix">
<link rel=canonical href=https://zhenfeng-zhu.github.io/posts/openfaas-workshop-lab4/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://zhenfeng-zhu.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://zhenfeng-zhu.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://zhenfeng-zhu.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://zhenfeng-zhu.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://zhenfeng-zhu.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="openfaas-workshop-lab4">
<meta property="og:description" content="实验 4&ndash;更深入地使用函数 在开始本实验之前，为你的文件创建一个新的文件夹。由于本实验是建立在早期实验的基础上的，所以请复制 lab3。
$ cp -r lab3 lab4\ && cd lab4 通过环境变量注入配置 能够控制一个函数在运行时的行为方式是很有用的，我们至少可以通过两种方式来实现这一点。
在部署时 *在部署时设置环境变量
我们在Lab 3中用write_debug做了这个 - 你也可以在这里设置任何你想要的自定义环境变量 - 例如，如果你想为你的hello world函数配置一种语言，你可以引入一个spoken_language变量。
使用 HTTP 上下文&ndash;querystring / headers *使用 querystring 和 HTTP headers
另一个更动态的、可以在每个请求层面上改变的选项是使用查询字符串和 HTTP 头信息，两者都可以通过faas-cli或curl传递。
这些头信息通过环境变量暴露出来，所以它们很容易在你的函数中被使用。所以任何头信息都以Http_为前缀，所有-连字符都被替换成_下划线。
让我们用 querystring 和一个列出所有环境变量的函数来试试。
 使用 BusyBox 的内置命令，部署一个打印环境变量的函数。  faas-cli deploy --name env --fprocess=&#34;env&#34; --image=&#34;function/alpine:latest&#34;  用一个查询字符串调用该函数。  $ echo &#34;&#34; | faas-cli invoke env --query workshop=1 PATH=/usr/local/bin:/usr/local/bin:/usr/bin:/sbin:/bin HOSTNAME=05e8db360c5a fprocess=env HOME=/root Http_Connection=close Http_Content_Type=text/plain Http_X_Call_Id=cdbed396-a20a-43fe-9123-1d5a122c976d Http_X_Forwarded_For=10.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://zhenfeng-zhu.github.io/posts/openfaas-workshop-lab4/"><meta property="og:image" content="https://zhenfeng-zhu.github.io/papermod-cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-07-02T09:32:59+00:00">
<meta property="article:modified_time" content="2018-07-02T09:32:59+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://zhenfeng-zhu.github.io/papermod-cover.png">
<meta name=twitter:title content="openfaas-workshop-lab4">
<meta name=twitter:description content="实验 4&ndash;更深入地使用函数 在开始本实验之前，为你的文件创建一个新的文件夹。由于本实验是建立在早期实验的基础上的，所以请复制 lab3。
$ cp -r lab3 lab4\ && cd lab4 通过环境变量注入配置 能够控制一个函数在运行时的行为方式是很有用的，我们至少可以通过两种方式来实现这一点。
在部署时 *在部署时设置环境变量
我们在Lab 3中用write_debug做了这个 - 你也可以在这里设置任何你想要的自定义环境变量 - 例如，如果你想为你的hello world函数配置一种语言，你可以引入一个spoken_language变量。
使用 HTTP 上下文&ndash;querystring / headers *使用 querystring 和 HTTP headers
另一个更动态的、可以在每个请求层面上改变的选项是使用查询字符串和 HTTP 头信息，两者都可以通过faas-cli或curl传递。
这些头信息通过环境变量暴露出来，所以它们很容易在你的函数中被使用。所以任何头信息都以Http_为前缀，所有-连字符都被替换成_下划线。
让我们用 querystring 和一个列出所有环境变量的函数来试试。
 使用 BusyBox 的内置命令，部署一个打印环境变量的函数。  faas-cli deploy --name env --fprocess=&#34;env&#34; --image=&#34;function/alpine:latest&#34;  用一个查询字符串调用该函数。  $ echo &#34;&#34; | faas-cli invoke env --query workshop=1 PATH=/usr/local/bin:/usr/local/bin:/usr/bin:/sbin:/bin HOSTNAME=05e8db360c5a fprocess=env HOME=/root Http_Connection=close Http_Content_Type=text/plain Http_X_Call_Id=cdbed396-a20a-43fe-9123-1d5a122c976d Http_X_Forwarded_For=10.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://zhenfeng-zhu.github.io/posts/"},{"@type":"ListItem","position":3,"name":"openfaas-workshop-lab4","item":"https://zhenfeng-zhu.github.io/posts/openfaas-workshop-lab4/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"openfaas-workshop-lab4","name":"openfaas-workshop-lab4","description":"实验 4\u0026ndash;更深入地使用函数 在开始本实验之前，为你的文件创建一个新的文件夹。由于本实验是建立在早期实验的基础上的，所以请复制 lab3。\n$ cp -r lab3 lab4\\ \u0026amp;\u0026amp; cd lab4 通过环境变量注入配置 能够控制一个函数在运行时的行为方式是很有用的，我们至少可以通过两种方式来实现这一点。\n在部署时 *在部署时设置环境变量\n我们在Lab 3中用write_debug做了这个 - 你也可以在这里设置任何你想要的自定义环境变量 - 例如，如果你想为你的hello world函数配置一种语言，你可以引入一个spoken_language变量。\n使用 HTTP 上下文\u0026ndash;querystring / headers *使用 querystring 和 HTTP headers\n另一个更动态的、可以在每个请求层面上改变的选项是使用查询字符串和 HTTP 头信息，两者都可以通过faas-cli或curl传递。\n这些头信息通过环境变量暴露出来，所以它们很容易在你的函数中被使用。所以任何头信息都以Http_为前缀，所有-连字符都被替换成_下划线。\n让我们用 querystring 和一个列出所有环境变量的函数来试试。\n 使用 BusyBox 的内置命令，部署一个打印环境变量的函数。  faas-cli deploy --name env --fprocess=\u0026#34;env\u0026#34; --image=\u0026#34;function/alpine:latest\u0026#34;  用一个查询字符串调用该函数。  $ echo \u0026#34;\u0026#34; | faas-cli invoke env --query workshop=1 PATH=/usr/local/bin:/usr/local/bin:/usr/bin:/sbin:/bin HOSTNAME=05e8db360c5a fprocess=env HOME=/root Http_Connection=close Http_Content_Type=text/plain Http_X_Call_Id=cdbed396-a20a-43fe-9123-1d5a122c976d Http_X_Forwarded_For=10.","keywords":[],"articleBody":"实验 4–更深入地使用函数 在开始本实验之前，为你的文件创建一个新的文件夹。由于本实验是建立在早期实验的基础上的，所以请复制 lab3。\n$ cp -r lab3 lab4\\ \u0026\u0026 cd lab4 通过环境变量注入配置 能够控制一个函数在运行时的行为方式是很有用的，我们至少可以通过两种方式来实现这一点。\n在部署时 *在部署时设置环境变量\n我们在Lab 3中用write_debug做了这个 - 你也可以在这里设置任何你想要的自定义环境变量 - 例如，如果你想为你的hello world函数配置一种语言，你可以引入一个spoken_language变量。\n使用 HTTP 上下文–querystring / headers *使用 querystring 和 HTTP headers\n另一个更动态的、可以在每个请求层面上改变的选项是使用查询字符串和 HTTP 头信息，两者都可以通过faas-cli或curl传递。\n这些头信息通过环境变量暴露出来，所以它们很容易在你的函数中被使用。所以任何头信息都以Http_为前缀，所有-连字符都被替换成_下划线。\n让我们用 querystring 和一个列出所有环境变量的函数来试试。\n 使用 BusyBox 的内置命令，部署一个打印环境变量的函数。  faas-cli deploy --name env --fprocess=\"env\" --image=\"function/alpine:latest\"  用一个查询字符串调用该函数。  $ echo \"\" | faas-cli invoke env --query workshop=1 PATH=/usr/local/bin:/usr/local/bin:/usr/bin:/sbin:/bin HOSTNAME=05e8db360c5a fprocess=env HOME=/root Http_Connection=close Http_Content_Type=text/plain Http_X_Call_Id=cdbed396-a20a-43fe-9123-1d5a122c976d Http_X_Forwarded_For=10.255.0.2 Http_X_Start_Time=1519729562486546741 Http_User_Agent=Go-http-client/1.1 Http_Accept_Encoding=gzip Http_Method=POST Http_ContentLength=-1 Http_Path=/ ... Http_Query=workshop=1 ... 在 Python 代码中，你会输入os.getenv(\"Http_Query\")。\n 将路径附加到你的函数 URL 上  用以下方法调用 env 函数。\n$ curl -X GET $OPENFAAS_URL/function/env/some/path -d \"\" PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/bin HOSTNAME=fae2ac4b75f9 fprocess=env HOME=/root Http_X_Forwarded_Host=127.0.0.1:8080 Http_X_Start_Time=1539370471902481800 Http_Accept_Encoding=gzip Http_User_Agent=curl/7.54.0 Http_Accept=*/* Http_X_Forwarded_For=10.255.0.2:60460 Http_X_Call_Id=bb86b4fb-641b-463d-ae45-af68c1aa0d42 Http_Method=GET Http_ContentLength=0 ... Http_Path=/some/path ... 正如你所看到的，Http_Path头包含你的路径。 如果你想在你的代码中使用它，只要用os.getenv(\"Http_Path\")来获取它。\n 现在用标头来调用它。  $ curl $OPENFAAS_URL/function/env --header \"X-Output-Mode: json\" -d \"\" PATH=/usr/local/bin:/usr/local/bin:/usr/bin:/sbin:/bin HOSTNAME=05e8db360c5a fprocess=env HOME=/root Http_X_Call_Id=8e597bcf-614f-4ca5-8f2e-f345d660db5e Http_X_Forwarded_For=10.255.0.2 Http_X_Start_Time=1519729577415481886 Http_Accept=*/* Http_Accept_Encoding=gzip Http_Connection=close Http_User_Agent=curl/7.55.1 Http_Method=GET Http_ContentLength=0 Http_Path=/ ... Http_X_Output_Mode=json ... 在 Python 代码中，你会输入`os.getenv(“Http_X_Output_Mode”)'。\n你可以看到所有其他的 HTTP 上下文也被提供了，比如当 Http_Method是 POST时的 Content-Length，User_Agent，Cookies 和其他你期望从 HTTP 请求中看到的东西。\n安全：只读文件系统 OpenFaaS 可以使用的容器安全特性之一是使我们执行环境的根文件系统只读的能力。如果一个函数被破坏，这可以减少攻击面。\n生成一个函数，将文件保存到函数的文件系统中。\nfaas-cli new --lang python3 ingest-file --prefix=your-name 更新处理程序。\nimport os import time def handle(req): # Read the path or a default from environment variable path = os.getenv(\"save_path\", \"/home/app/\") # generate a name using the current timestamp t = time.time() file_name = path + str(t) # write a file with open(file_name, \"w\") as f: f.write(req) f.close() return file_name 建立这个例子。\nfaas-cli up -f ingest-file.yml 调用该例子。\necho \"Hello function\"  message.txt cat message.txt | faas-cli invoke -f ingest-file.yml ingest-file 该文件将被写入/home/app路径中。\n现在编辑 ingest-file.yml 并使该函数为只读。\n... functions: ingest-file: lang: python3 handler: ./ingest-file image: alexellis2/ingest-file:latest readonly_root_filesystem: true  也请参见。YAML 参考\n 再次部署。\nfaas-cli up -f ingest-file.yml 现在这将会失败。\necho \"Hello function\"  message.txt cat message.txt | faas-cli invoke -f ingest-file.yml ingest-file 请看错误。\nServer returned unexpected status code: 500 - exit status 1 Traceback (most recent call last): File \"index.py\", line 19, in  ret = handler.handle(st) File \"/home/app/function/handler.py\", line 13, in handle with open(file_name, \"w\") as f: OSError: [Errno 30] Read-only file system: '/home/app/1556714998.092464' 为了写到一个临时区域，设置环境变量save_path。\n... functions: ingest-file: lang: python3 handler: ./ingest-file image: alexellis2/ingest-file:latest readonly_root_filesystem: true environment: save_path: \"/tmp/\" 现在你可以再运行一次faas-cli up -f ingest-file.yml来测试这个修正，文件将被写入/tmp/。\n我们现在有能力锁定我们的函数代码，使其不能被意外改变或恶意更新。\n利用日志记录 OpenFaaS 看门狗通过标准 I/O 流stdin和stdout传入 HTTP 请求和读取 HTTP 响应来运行。这意味着作为一个函数运行的进程不需要知道任何关于网络或 HTTP 的信息。\n一个有趣的情况是，当一个函数以非零退出代码退出时，stderr不是空的。 默认情况下，一个函数的stdout/stderr是合并的，stderr不被打印到日志中。\n让我们用Lab 3中的hello-openfaas函数来检查。\n将handler.py的代码改为\nimport sys import json def handle(req): sys.stderr.write(\"This should be an error message.\\n\") return json.dumps({\"Hello\": \"OpenFaaS\"}) 构建和部署\nfaas-cli up -f hello-openfaas.yml 现在用以下方法调用该函数\necho | faas-cli invoke hello-openfaas 你应该看到合并输出。\nThis should be an error message. {\"Hello\": \"OpenFaaS\"}  注意：如果你用docker service logs hello-openfaas检查容器日志（或者kubectl logs deployment/hello-openfaas -n openfaas-fn），你应该看不到 stderr 输出。\n 在这个例子中，我们需要这个函数返回有效的 JSON，可以被解析。不幸的是，日志信息使输出无效。 所以我们需要将这些信息从 stderr 重定向到容器的日志中。 OpenFaaS 提供了一个解决方案，所以你可以将错误信息打印到日志中，并保持函数响应的清晰，只返回stdout。 为此你应该使用combine_output标志。\n让我们来试试。打开hello-openfaas.yml文件，添加这些行。\nenvironment: combine_output: false 部署并调用该函数。\n输出应该是。\n{\"Hello\": \"OpenFaaS\"} 检查容器日志中的stderr。你应该看到类似的信息。\nhello-openfaas.1.2xtrr2ckkkth@linuxkit-025000000001 | 2018/04/03 08:35:24 stderr: This should be an error message. 创建工作流 在有些情况下，把一个函数的输出作为另一个函数的输入是很有用的。 这在客户端和通过 API 网关都可以实现。\n客户端上的连锁函数 你可以使用curl、faas-cli或一些你自己的代码将一个函数的结果输送到另一个函数。这里有一个例子。\n优点。\n 不需要代码 - 可以用 CLI 程序完成 *快速开发和测试 *容易在代码中建模  缺点。\n 额外的延迟 - 每个函数都要返回到服务器上 聊天（更多的信息）  例子。\n  从函数库部署 NodeInfo 函数\n  然后通过 Markdown 转换器推送 NodeInfo 的输出\n  $ echo -n \"\" | faas-cli invoke nodeinfo | faas-cli invoke markdown Hostname: 64767782518c\nPlatform: linux Arch: x64 CPU count: 4 Uptime: 1121466\n现在你会看到 NodeInfo 函数的输出被装饰成 HTML 标签，例如。.\n另一个客户端函数链的例子可能是调用一个生成图像的函数，然后将该图像发送到另一个添加水印的函数中。\n从另一个函数中调用一个函数 从另一个函数中调用一个函数的最简单方法是通过 OpenFaaS API 网关通过 HTTP 进行调用。这个调用不需要知道外部域名或 IP 地址，它可以简单地通过 DNS 条目将 API 网关称为gateway。\n当从一个函数访问 API 网关等服务时，最好的做法是使用环境变量来配置主机名，这很重要，有两个原因–名称可能会改变，在 Kubernetes 中有时需要一个后缀。\n优点。\n 函数之间可以直接利用对方 低延迟，因为函数可以在同一网络上相互访问  缺点。\n 需要一个代码库来进行 HTTP 请求  例子。\n在实验室 3中，我们介绍了 request 模块，并使用它来调用一个远程 API，以获得国际空间站上的一个宇航员的名字。我们可以使用同样的技术来调用部署在 OpenFaaS 上的另一个函数。\n 使用用户界面，进入函数商店并部署情感分析函数。  或者使用 CLI。\nfaas-cli store deploy SentimentAnalysis 情感分析函数将告诉你任何句子的主观性和极性（积极性评级）。该函数的结果是以 JSON 格式显示的，如下面的例子。\n$ echo -n \"California is great, it's always sunny there.\" | faas-cli invoke sentimentanalysis {\"polarity\": 0.8, \"sentence_count\": 1, \"subjectivity\": 0.75} 因此，结果显示我们的测试句子既非常主观（75%）又非常积极（80%）。这两个字段的值总是在-1.00和1.00之间。\n下面的代码可以用来调用情绪分析函数或任何其他函数。\n给网关主机加上openfaas命名空间的后缀。\nr = requests.get(\"http://gateway.openfaas:8080/function/sentimentanalysis\", text= test_sentence) 或者通过一个环境变量。\ngateway_hostname = os.getenv(\"gateway_hostname\", \"gateway.openfaas\") # uses a default of \"gateway.openfaas\" for when \"gateway_hostname\" is not set test_sentence = \"California is great, it's always sunny there.\" r = requests.get(\"http://\" + gateway_hostname + \":8080/function/sentimentanalysis\", data= test_sentence) 由于结果总是以 JSON 格式出现，我们可以利用辅助函数.json()来转换响应。\nresult = r.json() if result[\"polarity\"]  0.45: return \"That was probably positive\" else: return \"That was neutral or negative\" 现在，在 Python 中创建一个新的函数，并将其全部整合起来\nimport os import requests import sys def handle(req): \"\"\"handle a request to the function Args: req (str): request body \"\"\" gateway_hostname = os.getenv(\"gateway_hostname\", \"gateway.openfaas\") # uses a default of \"gateway\" for when \"gateway_hostname\" is not set test_sentence = req r = requests.get(\"http://\" + gateway_hostname + \":8080/function/sentimentanalysis\", data= test_sentence) if r.status_code != 200: sys.exit(\"Error with sentimentanalysis, expected: %d, got: %d\\n\" % (200, r.status_code)) result = r.json() if result[\"polarity\"]  0.45: return \"That was probably positive\" else: return \"That was neutral or negative\"  记得在你的requirements.txt文件中加入requests。  注意：你不需要修改或改变 SentimentAnalysis 函数的源代码，我们已经部署了它并将通过 API 网关访问它。\n现在转到实验室 5。\n","wordCount":"693","inLanguage":"en","datePublished":"2018-07-02T09:32:59Z","dateModified":"2018-07-02T09:32:59Z","author":{"@type":"Person","name":"Fenix"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zhenfeng-zhu.github.io/posts/openfaas-workshop-lab4/"},"publisher":{"@type":"Organization","name":"Awesome Fenix","logo":{"@type":"ImageObject","url":"https://zhenfeng-zhu.github.io/favicon.ico"}}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8502076734034112" crossorigin=anonymous></script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://zhenfeng-zhu.github.io accesskey=h title="Awesome Fenix (Alt + H)">Awesome Fenix</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://zhenfeng-zhu.github.io/archives/ title=Archives>
<span>Archives</span>
</a>
</li>
<li>
<a href=https://zhenfeng-zhu.github.io/about title=About>
<span>About</span>
</a>
</li>
<li>
<a href=https://zhenfeng-zhu.github.io/search/ title=🔍>
<span>🔍</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://zhenfeng-zhu.github.io>Home</a>&nbsp;»&nbsp;<a href=https://zhenfeng-zhu.github.io/posts/>Posts</a></div>
<h1 class=post-title>
openfaas-workshop-lab4
</h1>
<div class=post-meta><span title="2018-07-02 09:32:59 +0000 UTC">July 2, 2018</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;Fenix&nbsp;|&nbsp;<a href=https://github.com/zhenfeng-zhu/zhenfeng-zhu.github.io/content rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#%e5%ae%9e%e9%aa%8c-4--%e6%9b%b4%e6%b7%b1%e5%85%a5%e5%9c%b0%e4%bd%bf%e7%94%a8%e5%87%bd%e6%95%b0 aria-label="实验 4&amp;ndash;更深入地使用函数">实验 4&ndash;更深入地使用函数</a><ul>
<li>
<a href=#%e9%80%9a%e8%bf%87%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e6%b3%a8%e5%85%a5%e9%85%8d%e7%bd%ae aria-label=通过环境变量注入配置>通过环境变量注入配置</a><ul>
<li>
<a href=#%e5%9c%a8%e9%83%a8%e7%bd%b2%e6%97%b6 aria-label=在部署时>在部署时</a></li>
<li>
<a href=#%e4%bd%bf%e7%94%a8-http-%e4%b8%8a%e4%b8%8b%e6%96%87--querystring--headers aria-label="使用 HTTP 上下文&amp;ndash;querystring / headers">使用 HTTP 上下文&ndash;querystring / headers</a></li></ul>
</li>
<li>
<a href=#%e5%ae%89%e5%85%a8%e5%8f%aa%e8%af%bb%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f aria-label=安全：只读文件系统>安全：只读文件系统</a></li>
<li>
<a href=#%e5%88%a9%e7%94%a8%e6%97%a5%e5%bf%97%e8%ae%b0%e5%bd%95 aria-label=利用日志记录>利用日志记录</a></li>
<li>
<a href=#%e5%88%9b%e5%bb%ba%e5%b7%a5%e4%bd%9c%e6%b5%81 aria-label=创建工作流>创建工作流</a><ul>
<li>
<a href=#%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%8a%e7%9a%84%e8%bf%9e%e9%94%81%e5%87%bd%e6%95%b0 aria-label=客户端上的连锁函数>客户端上的连锁函数</a></li>
<li>
<a href=#%e4%bb%8e%e5%8f%a6%e4%b8%80%e4%b8%aa%e5%87%bd%e6%95%b0%e4%b8%ad%e8%b0%83%e7%94%a8%e4%b8%80%e4%b8%aa%e5%87%bd%e6%95%b0 aria-label=从另一个函数中调用一个函数>从另一个函数中调用一个函数</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h1 id=实验-4--更深入地使用函数>实验 4&ndash;更深入地使用函数<a hidden class=anchor aria-hidden=true href=#实验-4--更深入地使用函数>#</a></h1>
<p></p>
<p>在开始本实验之前，为你的文件创建一个新的文件夹。由于本实验是建立在早期实验的基础上的，所以请复制 lab3。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>$ cp -r lab3 lab4\
   &amp;&amp; cd lab4
</code></pre></div><h2 id=通过环境变量注入配置>通过环境变量注入配置<a hidden class=anchor aria-hidden=true href=#通过环境变量注入配置>#</a></h2>
<p>能够控制一个函数在运行时的行为方式是很有用的，我们至少可以通过两种方式来实现这一点。</p>
<h3 id=在部署时>在部署时<a hidden class=anchor aria-hidden=true href=#在部署时>#</a></h3>
<p>*在部署时设置环境变量</p>
<p>我们在<a href=./lab3.md>Lab 3</a>中用<code>write_debug</code>做了这个 - 你也可以在这里设置任何你想要的自定义环境变量 - 例如，如果你想为你的<em>hello world</em>函数配置一种语言，你可以引入一个<code>spoken_language</code>变量。</p>
<h3 id=使用-http-上下文--querystring--headers>使用 HTTP 上下文&ndash;querystring / headers<a hidden class=anchor aria-hidden=true href=#使用-http-上下文--querystring--headers>#</a></h3>
<p>*使用 querystring 和 HTTP headers</p>
<p>另一个更动态的、可以在每个请求层面上改变的选项是使用查询字符串和 HTTP 头信息，两者都可以通过<code>faas-cli</code>或<code>curl</code>传递。</p>
<p>这些头信息通过环境变量暴露出来，所以它们很容易在你的函数中被使用。所以任何头信息都以<code>Http_</code>为前缀，所有<code>-</code>连字符都被替换成<code>_</code>下划线。</p>
<p>让我们用 querystring 和一个列出所有环境变量的函数来试试。</p>
<ul>
<li>使用 BusyBox 的内置命令，部署一个打印环境变量的函数。</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>faas-cli deploy --name env --fprocess=&#34;env&#34; --image=&#34;function/alpine:latest&#34;
</code></pre></div><ul>
<li>用一个查询字符串调用该函数。</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ echo <span style=color:#e6db74>&#34;&#34;</span> | faas-cli invoke env --query workshop<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
PATH<span style=color:#f92672>=</span>/usr/local/bin:/usr/local/bin:/usr/bin:/sbin:/bin
HOSTNAME<span style=color:#f92672>=</span>05e8db360c5a
fprocess<span style=color:#f92672>=</span>env
HOME<span style=color:#f92672>=</span>/root
Http_Connection<span style=color:#f92672>=</span>close
Http_Content_Type<span style=color:#f92672>=</span>text/plain
Http_X_Call_Id<span style=color:#f92672>=</span>cdbed396-a20a-43fe-9123-1d5a122c976d
Http_X_Forwarded_For<span style=color:#f92672>=</span>10.255.0.2
Http_X_Start_Time<span style=color:#f92672>=</span><span style=color:#ae81ff>1519729562486546741</span>
Http_User_Agent<span style=color:#f92672>=</span>Go-http-client/1.1
Http_Accept_Encoding<span style=color:#f92672>=</span>gzip
Http_Method<span style=color:#f92672>=</span>POST
Http_ContentLength<span style=color:#f92672>=</span>-1
Http_Path<span style=color:#f92672>=</span>/
...
Http_Query<span style=color:#f92672>=</span>workshop<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
...
</code></pre></div><p>在 Python 代码中，你会输入<code>os.getenv("Http_Query")</code>。</p>
<ul>
<li>将路径附加到你的函数 URL 上</li>
</ul>
<p>用以下方法调用 env 函数。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ curl -X GET $OPENFAAS_URL/function/env/some/path -d <span style=color:#e6db74>&#34;&#34;</span>
PATH<span style=color:#f92672>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/bin
HOSTNAME<span style=color:#f92672>=</span>fae2ac4b75f9
fprocess<span style=color:#f92672>=</span>env
HOME<span style=color:#f92672>=</span>/root
Http_X_Forwarded_Host<span style=color:#f92672>=</span>127.0.0.1:8080
Http_X_Start_Time<span style=color:#f92672>=</span><span style=color:#ae81ff>1539370471902481800</span>
Http_Accept_Encoding<span style=color:#f92672>=</span>gzip
Http_User_Agent<span style=color:#f92672>=</span>curl/7.54.0
Http_Accept<span style=color:#f92672>=</span>*/*
Http_X_Forwarded_For<span style=color:#f92672>=</span>10.255.0.2:60460
Http_X_Call_Id<span style=color:#f92672>=</span>bb86b4fb-641b-463d-ae45-af68c1aa0d42
Http_Method<span style=color:#f92672>=</span>GET
Http_ContentLength<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
...
Http_Path<span style=color:#f92672>=</span>/some/path
...
</code></pre></div><p>正如你所看到的，<code>Http_Path</code>头包含你的路径。
如果你想在你的代码中使用它，只要用<code>os.getenv("Http_Path")</code>来获取它。</p>
<ul>
<li>现在用标头来调用它。</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ curl $OPENFAAS_URL/function/env --header <span style=color:#e6db74>&#34;X-Output-Mode: json&#34;</span> -d <span style=color:#e6db74>&#34;&#34;</span>
PATH<span style=color:#f92672>=</span>/usr/local/bin:/usr/local/bin:/usr/bin:/sbin:/bin
HOSTNAME<span style=color:#f92672>=</span>05e8db360c5a
fprocess<span style=color:#f92672>=</span>env
HOME<span style=color:#f92672>=</span>/root
Http_X_Call_Id<span style=color:#f92672>=</span>8e597bcf-614f-4ca5-8f2e-f345d660db5e
Http_X_Forwarded_For<span style=color:#f92672>=</span>10.255.0.2
Http_X_Start_Time<span style=color:#f92672>=</span><span style=color:#ae81ff>1519729577415481886</span>
Http_Accept<span style=color:#f92672>=</span>*/*
Http_Accept_Encoding<span style=color:#f92672>=</span>gzip
Http_Connection<span style=color:#f92672>=</span>close
Http_User_Agent<span style=color:#f92672>=</span>curl/7.55.1
Http_Method<span style=color:#f92672>=</span>GET
Http_ContentLength<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>
Http_Path<span style=color:#f92672>=</span>/
...
Http_X_Output_Mode<span style=color:#f92672>=</span>json
...
</code></pre></div><p>在 Python 代码中，你会输入`os.getenv(&ldquo;Http_X_Output_Mode&rdquo;)'。</p>
<p>你可以看到所有其他的 HTTP 上下文也被提供了，比如当 <code>Http_Method</code>是 <code>POST</code>时的 <code>Content-Length</code>，<code>User_Agent</code>，Cookies 和其他你期望从 HTTP 请求中看到的东西。</p>
<h2 id=安全只读文件系统>安全：只读文件系统<a hidden class=anchor aria-hidden=true href=#安全只读文件系统>#</a></h2>
<p>OpenFaaS 可以使用的容器安全特性之一是使我们执行环境的根文件系统只读的能力。如果一个函数被破坏，这可以减少攻击面。</p>
<p>生成一个函数，将文件保存到函数的文件系统中。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>faas-cli new --lang python3 ingest-file --prefix<span style=color:#f92672>=</span>your-name
</code></pre></div><p>更新处理程序。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> os
<span style=color:#f92672>import</span> time

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(req):
    <span style=color:#75715e># Read the path or a default from environment variable</span>
    path <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;save_path&#34;</span>, <span style=color:#e6db74>&#34;/home/app/&#34;</span>)

    <span style=color:#75715e># generate a name using the current timestamp</span>
    t <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>time()
    file_name <span style=color:#f92672>=</span> path <span style=color:#f92672>+</span> str(t)

    <span style=color:#75715e># write a file</span>
    <span style=color:#66d9ef>with</span> open(file_name, <span style=color:#e6db74>&#34;w&#34;</span>) <span style=color:#66d9ef>as</span> f:
        f<span style=color:#f92672>.</span>write(req)
        f<span style=color:#f92672>.</span>close()

    <span style=color:#66d9ef>return</span> file_name
</code></pre></div><p>建立这个例子。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>faas-cli up -f ingest-file.yml
</code></pre></div><p>调用该例子。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo <span style=color:#e6db74>&#34;Hello function&#34;</span> &gt; message.txt

cat message.txt | faas-cli invoke -f ingest-file.yml ingest-file
</code></pre></div><p>该文件将被写入<code>/home/app</code>路径中。</p>
<p>现在编辑 ingest-file.yml 并使该函数为只读。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
<span style=color:#f92672>functions</span>:
  <span style=color:#f92672>ingest-file</span>:
    <span style=color:#f92672>lang</span>: <span style=color:#ae81ff>python3</span>
    <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>./ingest-file</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alexellis2/ingest-file:latest</span>
    <span style=color:#f92672>readonly_root_filesystem</span>: <span style=color:#66d9ef>true</span>
</code></pre></div><blockquote>
<p>也请参见。<a href=https://docs.openfaas.com/reference/yaml/#function-read-only-root-filesystem>YAML 参考</a></p>
</blockquote>
<p>再次部署。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>faas-cli up -f ingest-file.yml
</code></pre></div><p>现在这将会失败。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo <span style=color:#e6db74>&#34;Hello function&#34;</span> &gt; message.txt

cat message.txt | faas-cli invoke -f ingest-file.yml ingest-file
</code></pre></div><p>请看错误。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>Server returned unexpected status code: <span style=color:#ae81ff>500</span> - exit status <span style=color:#ae81ff>1</span>
Traceback <span style=color:#f92672>(</span>most recent call last<span style=color:#f92672>)</span>:
  File <span style=color:#e6db74>&#34;index.py&#34;</span>, line 19, in &lt;module&gt;
    ret <span style=color:#f92672>=</span> handler.handle<span style=color:#f92672>(</span>st<span style=color:#f92672>)</span>
  File <span style=color:#e6db74>&#34;/home/app/function/handler.py&#34;</span>, line 13, in handle
    with open<span style=color:#f92672>(</span>file_name, <span style=color:#e6db74>&#34;w&#34;</span><span style=color:#f92672>)</span> as f:
OSError: <span style=color:#f92672>[</span>Errno 30<span style=color:#f92672>]</span> Read-only file system: <span style=color:#e6db74>&#39;/home/app/1556714998.092464&#39;</span>
</code></pre></div><p>为了写到一个临时区域，设置环境变量<code>save_path</code>。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>...
<span style=color:#f92672>functions</span>:
  <span style=color:#f92672>ingest-file</span>:
    <span style=color:#f92672>lang</span>: <span style=color:#ae81ff>python3</span>
    <span style=color:#f92672>handler</span>: <span style=color:#ae81ff>./ingest-file</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>alexellis2/ingest-file:latest</span>
    <span style=color:#f92672>readonly_root_filesystem</span>: <span style=color:#66d9ef>true</span>
    <span style=color:#f92672>environment</span>:
        <span style=color:#f92672>save_path</span>: <span style=color:#e6db74>&#34;/tmp/&#34;</span>
</code></pre></div><p>现在你可以再运行一次<code>faas-cli up -f ingest-file.yml</code>来测试这个修正，文件将被写入<code>/tmp/</code>。</p>
<p>我们现在有能力锁定我们的函数代码，使其不能被意外改变或恶意更新。</p>
<h2 id=利用日志记录>利用日志记录<a hidden class=anchor aria-hidden=true href=#利用日志记录>#</a></h2>
<p>OpenFaaS 看门狗通过标准 I/O 流<code>stdin</code>和<code>stdout</code>传入 HTTP 请求和读取 HTTP 响应来运行。这意味着作为一个函数运行的进程不需要知道任何关于网络或 HTTP 的信息。</p>
<p>一个有趣的情况是，当一个函数以非零退出代码退出时，<code>stderr</code>不是空的。
默认情况下，一个函数的<code>stdout/stderr</code>是合并的，<code>stderr</code>不被打印到日志中。</p>
<p>让我们用<a href=./lab3.md#hello-world-in-python>Lab 3</a>中的<code>hello-openfaas</code>函数来检查。</p>
<p>将<code>handler.py</code>的代码改为</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> sys
<span style=color:#f92672>import</span> json

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(req):

    sys<span style=color:#f92672>.</span>stderr<span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#34;This should be an error message.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)
    <span style=color:#66d9ef>return</span> json<span style=color:#f92672>.</span>dumps({<span style=color:#e6db74>&#34;Hello&#34;</span>: <span style=color:#e6db74>&#34;OpenFaaS&#34;</span>})
</code></pre></div><p>构建和部署</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>faas-cli up -f hello-openfaas.yml
</code></pre></div><p>现在用以下方法调用该函数</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo | faas-cli invoke hello-openfaas
</code></pre></div><p>你应该看到合并输出。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>This should be an error message.
{&#34;Hello&#34;: &#34;OpenFaaS&#34;}
</code></pre></div><blockquote>
<p>注意：如果你用<code>docker service logs hello-openfaas</code>检查容器日志（或者<code>kubectl logs deployment/hello-openfaas -n openfaas-fn</code>），你应该看不到 stderr 输出。</p>
</blockquote>
<p>在这个例子中，我们需要这个函数返回有效的 JSON，可以被解析。不幸的是，日志信息使输出无效。
所以我们需要将这些信息从 stderr 重定向到容器的日志中。
OpenFaaS 提供了一个解决方案，所以你可以将错误信息打印到日志中，并保持函数响应的清晰，只返回<code>stdout</code>。
为此你应该使用<code>combine_output</code>标志。</p>
<p>让我们来试试。打开<code>hello-openfaas.yml</code>文件，添加这些行。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    <span style=color:#f92672>environment</span>:
      <span style=color:#f92672>combine_output</span>: <span style=color:#66d9ef>false</span>
</code></pre></div><p>部署并调用该函数。</p>
<p>输出应该是。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>{&#34;Hello&#34;: &#34;OpenFaaS&#34;}
</code></pre></div><p>检查容器日志中的<code>stderr</code>。你应该看到类似的信息。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>hello-openfaas.1.2xtrr2ckkkth@linuxkit-025000000001    | 2018/04/03 08:35:24 stderr: This should be an error message.
</code></pre></div><h2 id=创建工作流>创建工作流<a hidden class=anchor aria-hidden=true href=#创建工作流>#</a></h2>
<p>在有些情况下，把一个函数的输出作为另一个函数的输入是很有用的。 这在客户端和通过 API 网关都可以实现。</p>
<h3 id=客户端上的连锁函数>客户端上的连锁函数<a hidden class=anchor aria-hidden=true href=#客户端上的连锁函数>#</a></h3>
<p>你可以使用<code>curl</code>、<code>faas-cli</code>或一些你自己的代码将一个函数的结果输送到另一个函数。这里有一个例子。</p>
<p>优点。</p>
<ul>
<li>不需要代码 - 可以用 CLI 程序完成
*快速开发和测试
*容易在代码中建模</li>
</ul>
<p>缺点。</p>
<ul>
<li>额外的延迟 - 每个函数都要返回到服务器上</li>
<li>聊天（更多的信息）</li>
</ul>
<p>例子。</p>
<ul>
<li>
<p>从<em>函数库</em>部署 NodeInfo 函数</p>
</li>
<li>
<p>然后通过 Markdown 转换器推送 NodeInfo 的输出</p>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ echo -n <span style=color:#e6db74>&#34;&#34;</span> | faas-cli invoke nodeinfo | faas-cli invoke markdown
&lt;p&gt;Hostname: 64767782518c&lt;/p&gt;

&lt;p&gt;Platform: linux
Arch: x64
CPU count: <span style=color:#ae81ff>4</span>
Uptime: 1121466&lt;/p&gt;
</code></pre></div><p>现在你会看到 NodeInfo 函数的输出被装饰成 HTML 标签，例如。<code>&lt;p></code>.</p>
<p>另一个客户端函数链的例子可能是调用一个生成图像的函数，然后将该图像发送到另一个添加水印的函数中。</p>
<h3 id=从另一个函数中调用一个函数>从另一个函数中调用一个函数<a hidden class=anchor aria-hidden=true href=#从另一个函数中调用一个函数>#</a></h3>
<p>从另一个函数中调用一个函数的最简单方法是通过 OpenFaaS <em>API 网关</em>通过 HTTP 进行调用。这个调用不需要知道外部域名或 IP 地址，它可以简单地通过 DNS 条目将 API 网关称为<code>gateway</code>。</p>
<p>当从一个函数访问 API 网关等服务时，最好的做法是使用环境变量来配置主机名，这很重要，有两个原因&ndash;名称可能会改变，在 Kubernetes 中有时需要一个后缀。</p>
<p>优点。</p>
<ul>
<li>函数之间可以直接利用对方</li>
<li>低延迟，因为函数可以在同一网络上相互访问</li>
</ul>
<p>缺点。</p>
<ul>
<li>需要一个代码库来进行 HTTP 请求</li>
</ul>
<p>例子。</p>
<p>在<a href=./lab3.md>实验室 3</a>中，我们介绍了 request 模块，并使用它来调用一个远程 API，以获得国际空间站上的一个宇航员的名字。我们可以使用同样的技术来调用部署在 OpenFaaS 上的另一个函数。</p>
<ul>
<li>使用用户界面，进入<em>函数商店</em>并部署<em>情感分析</em>函数。</li>
</ul>
<p>或者使用 CLI。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain>faas-cli store deploy SentimentAnalysis
</code></pre></div><p>情感分析函数将告诉你任何句子的主观性和极性（积极性评级）。该函数的结果是以 JSON 格式显示的，如下面的例子。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ echo -n <span style=color:#e6db74>&#34;California is great, it&#39;s always sunny there.&#34;</span> | faas-cli invoke sentimentanalysis
<span style=color:#f92672>{</span><span style=color:#e6db74>&#34;polarity&#34;</span>: 0.8, <span style=color:#e6db74>&#34;sentence_count&#34;</span>: 1, <span style=color:#e6db74>&#34;subjectivity&#34;</span>: 0.75<span style=color:#f92672>}</span>
</code></pre></div><p>因此，结果显示我们的测试句子既非常主观（75%）又非常积极（80%）。这两个字段的值总是在<code>-1.00</code>和<code>1.00</code>之间。</p>
<p>下面的代码可以用来调用<em>情绪分析</em>函数或任何其他函数。</p>
<p>给网关主机加上<code>openfaas</code>命名空间的后缀。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;http://gateway.openfaas:8080/function/sentimentanalysis&#34;</span>, text<span style=color:#f92672>=</span> test_sentence)
</code></pre></div><p>或者通过一个环境变量。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    gateway_hostname <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;gateway_hostname&#34;</span>, <span style=color:#e6db74>&#34;gateway.openfaas&#34;</span>) <span style=color:#75715e># uses a default of &#34;gateway.openfaas&#34; for when &#34;gateway_hostname&#34; is not set</span>
    test_sentence <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;California is great, it&#39;s always sunny there.&#34;</span>
    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> gateway_hostname <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:8080/function/sentimentanalysis&#34;</span>, data<span style=color:#f92672>=</span> test_sentence)
</code></pre></div><p>由于结果总是以 JSON 格式出现，我们可以利用辅助函数<code>.json()</code>来转换响应。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    result <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>json()
    <span style=color:#66d9ef>if</span> result[<span style=color:#e6db74>&#34;polarity&#34;</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0.45</span>:
       <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;That was probably positive&#34;</span>
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;That was neutral or negative&#34;</span>
</code></pre></div><p>现在，在 Python 中创建一个新的函数，并将其全部整合起来</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> os
<span style=color:#f92672>import</span> requests
<span style=color:#f92672>import</span> sys

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>handle</span>(req):
    <span style=color:#e6db74>&#34;&#34;&#34;handle a request to the function
</span><span style=color:#e6db74>    Args:
</span><span style=color:#e6db74>        req (str): request body
</span><span style=color:#e6db74>    &#34;&#34;&#34;</span>

    gateway_hostname <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;gateway_hostname&#34;</span>, <span style=color:#e6db74>&#34;gateway.openfaas&#34;</span>) <span style=color:#75715e># uses a default of &#34;gateway&#34; for when &#34;gateway_hostname&#34; is not set</span>

    test_sentence <span style=color:#f92672>=</span> req

    r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;http://&#34;</span> <span style=color:#f92672>+</span> gateway_hostname <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:8080/function/sentimentanalysis&#34;</span>, data<span style=color:#f92672>=</span> test_sentence)

    <span style=color:#66d9ef>if</span> r<span style=color:#f92672>.</span>status_code <span style=color:#f92672>!=</span> <span style=color:#ae81ff>200</span>:
        sys<span style=color:#f92672>.</span>exit(<span style=color:#e6db74>&#34;Error with sentimentanalysis, expected: </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>, got: </span><span style=color:#e6db74>%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (<span style=color:#ae81ff>200</span>, r<span style=color:#f92672>.</span>status_code))

    result <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>json()
    <span style=color:#66d9ef>if</span> result[<span style=color:#e6db74>&#34;polarity&#34;</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0.45</span>:
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;That was probably positive&#34;</span>
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;That was neutral or negative&#34;</span>
</code></pre></div><ul>
<li>记得在你的<code>requirements.txt</code>文件中加入<code>requests</code>。</li>
</ul>
<p>注意：你不需要修改或改变 SentimentAnalysis 函数的源代码，我们已经部署了它并将通过 API 网关访问它。</p>
<p>现在转到<a href=lab5.md>实验室 5</a>。</p>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://zhenfeng-zhu.github.io/posts/openfaas-on-rancher/>
<span class=title>« Prev Page</span>
<br>
<span>OpenFaaS on Rancher 2.0</span>
</a>
<a class=next href=https://zhenfeng-zhu.github.io/posts/ubuntu-docker-sudo/>
<span class=title>Next Page »</span>
<br>
<span>ubuntu-docker-sudo</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on twitter" href="https://twitter.com/intent/tweet/?text=openfaas-workshop-lab4&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f&title=openfaas-workshop-lab4&summary=openfaas-workshop-lab4&source=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f&title=openfaas-workshop-lab4"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on whatsapp" href="https://api.whatsapp.com/send?text=openfaas-workshop-lab4%20-%20https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share openfaas-workshop-lab4 on telegram" href="https://telegram.me/share/url?text=openfaas-workshop-lab4&url=https%3a%2f%2fzhenfeng-zhu.github.io%2fposts%2fopenfaas-workshop-lab4%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><script src=https://utteranc.es/client.js repo=zhenfeng-zhu/zhenfeng-zhu.github.io issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://zhenfeng-zhu.github.io>Awesome Fenix</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>