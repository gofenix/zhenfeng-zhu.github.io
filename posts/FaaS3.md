---
title: FaaS3
publish_date: 2023-01-07
---

# å¦‚ä½•ç”¨ Deno+åŒºå—é“¾æ‰“é€ ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„ FaaS å¹³å°

# ä»€ä¹ˆæ˜¯ Web3 åº”ç”¨æ¶æ„

![](https://raw.githubusercontent.com/zhenfeng-zhu/pic-go/main/202301072214479.png)

å¤§å¤šæ•°çš„ web3 åº”ç”¨éƒ½éµå¾ªäº†å¦‚ä¸‹çš„æ¶æ„ï¼š

- ç®€å•åº”ç”¨ï¼ˆçº¯é“¾ä¸Šæ•°æ®ä¸”äº¤äº’å¹¶ä¸å¤æ‚ï¼‰ï¼Œä¾‹å¦‚ï¼šuniswap ä»¥åŠçº¯é“¾ä¸Šçš„ NFT é¡¹ç›®
- å‰ç«¯ä¸ web2 åº”ç”¨æ²¡æœ‰åŒºåˆ«
- æ— åç«¯
- åŒºå—é“¾ä½œä¸ºæ•°æ®åº“

# Deno

ä¼—æ‰€å‘¨çŸ¥ï¼Œv8 æ˜¯ Chrome å†…éƒ¨çš„ JavaScript æ‰§è¡Œå¼•æ“ï¼Œå®ƒä¼˜å¼‚çš„ JIT
èƒ½åŠ›ï¼Œä»¥åŠé«˜æ•ˆçš„åƒåœ¾å›æ”¶ï¼Œä½¿å¾— Chrome æˆä¸ºæœ€å¿«æœ€æˆåŠŸçš„æµè§ˆå™¨ã€‚v8
ä»…ä»…è¢«ç”¨åœ¨æµè§ˆå™¨ä¸­æœ‰äº›æš´æ®„å¤©ç‰©ï¼Œäºæ˜¯åå¤šå¹´å‰ï¼ˆ2009ï¼‰ï¼ŒRyan Dahl æŠŠ v8
å¼•å…¥äº†æœåŠ¡ç«¯ï¼Œåˆ›å»ºäº† nodejsã€‚node
ä»¥ç®€å•å®¹æ˜“ä¸Šæ‰‹çš„ç¼–ç¨‹æ¨¡å‹ï¼ˆå•çº¿ç¨‹ã€å¼‚æ­¥å¤„ç†ï¼‰ä¸€ä¸¾æˆä¸ºäº†å¹¿å—æ¬¢è¿çš„æœåŠ¡ç«¯å¼€å‘å·¥å…·ã€‚

![](https://raw.githubusercontent.com/zhenfeng-zhu/pic-go/main/202301072215848.png)

ry åœ¨å‡ å¹´åï¼Œè‡ªæˆ‘é©å‘½ï¼Œé‡æ–°ç”¨ v8 æ‰“é€  denoï¼Œæ„æ¬²å°† deno
æˆä¸ºä¸‹ä¸€ä»£å¼€å‘çš„ç‹è€…ã€‚Deno çš„åŠŸèƒ½äº®ç‚¹åŒ…æ‹¬ï¼š

- é»˜è®¤å®‰å…¨ã€‚å¤–éƒ¨ä»£ç æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€ç¯å¢ƒçš„è®¿é—®æƒé™ï¼Œé™¤éæ˜¾å¼å¼€å¯ã€‚
- æ”¯æŒå¼€ç®±å³ç”¨çš„ TypeScript çš„ç¯å¢ƒã€‚
- åªåˆ†å‘ä¸€ä¸ªç‹¬ç«‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆdenoï¼‰ã€‚
- æœ‰ç€å†…å»ºçš„å·¥å…·ç®±ï¼Œæ¯”å¦‚ä¸€ä¸ªä¾èµ–ä¿¡æ¯æŸ¥çœ‹å™¨ï¼ˆdeno
  infoï¼‰å’Œä¸€ä¸ªä»£ç æ ¼å¼åŒ–å·¥å…·ï¼ˆdeno fmtï¼‰ã€‚
- æœ‰ä¸€ç»„ç»è¿‡å®¡è®¡çš„ æ ‡å‡†æ¨¡å—ï¼Œä¿è¯èƒ½åœ¨ Deno ä¸Šå·¥ä½œã€‚
- è„šæœ¬ä»£ç èƒ½è¢«æ‰“åŒ…ä¸ºä¸€ä¸ªå•ç‹¬çš„ JavaScript æ–‡ä»¶ã€‚

# æ²™ç®±

æˆ‘è®¤ä¸ºå¯èƒ½æ˜¯ deno ç›¸å¯¹äº node åšå‡ºçš„æœ€é‡è¦çš„æ¶æ„ä¸Šçš„é‡å¡‘ï¼Œå°±æ˜¯ securityã€‚v8
å€¾å°½å…¨åŠ›æ‰“é€ äº†ä¸€ä¸ªå®‰å…¨çš„æ²™ç®±ï¼Œnode å´åªå…³å¿ƒå…¶ javascript
è§£é‡Šå™¨ï¼Œè€Œåœ¨ç°åœ¨ï¼ŒæœåŠ¡å™¨çš„ä¸–ç•Œå°±è¿›å…¥äº†ä¸€ä¸ªæ²™ç®±ï¼ˆVM / container /
wasmï¼‰æ¨ªè¡Œçš„æ—¶ä»£ã€‚

![](https://raw.githubusercontent.com/zhenfeng-zhu/pic-go/main/202301072215245.png)

deno çœ‹ä¸Šå»åƒæ˜¯ä¸€ä¸ªæœåŠ¡ç«¯çš„ chromeã€‚å®ƒç”¨ isolate (éš”ç¦»)
éš”ç¦»ç”¨æˆ·çš„ä»£ç ï¼Œå¹¶å¯ä»¥åœ¨æçŸ­çš„æ—¶é—´å†…åŠ è½½å¹¶è¿è¡Œå‡ ä¹ä¸å¯èƒ½è¿›è¡Œä»»ä½•æ¶æ„è¡Œä¸ºçš„ç”¨æˆ·ä»£ç ï¼ˆå¦‚æœæƒé™æ§åˆ¶å¾—å½“ï¼‰ã€‚

# å»ä¸­å¿ƒåŒ– http import

åœ¨ä½¿ç”¨ deno çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸ç”¨å†ä¾èµ– NPMï¼Œä¹Ÿä¸éœ€è¦ package.jsonã€‚æ¯ä¸ªåŒ…

éƒ½æ˜¯ä»ä¸€ä¸ª URL åŠ è½½ã€‚

åœ¨ node ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ä¸€ä¸ªè½¯ä»¶åŒ…ï¼Œå¿…é¡»å…ˆä» NPM å®‰è£…å®ƒï¼š

```jsx
npm i moment
```

ç­‰å®ƒå®‰è£…å®Œæ¯•åï¼Œæ‰èƒ½åœ¨ç¨‹åºä¸­ä½¿ç”¨ï¼š

```jsx
const moment = require("moment");
```

è¿™ä¸ªæ˜¯ç›¸å½“çš„ä¸­å¿ƒåŒ–ï¼Œ

ä¸ç®¡æ˜¯è°è¦åœ¨æœ¬åœ°è¿è¡Œä½ çš„ NodeJS å­˜å‚¨åº“ï¼Œéƒ½å¿…é¡»ä» NPM å®‰è£…æ‰€æœ‰ä¾èµ–é¡¹ã€‚è€Œ
webï¼Œæœ¬æ¥å°±æ”¯æŒ http importï¼Œå»ä¸­å¿ƒåŒ–çš„ï¼Œnpm ç®¡ç†åè€Œæ˜¯åæ¥å¼€å‘çš„ã€‚

![](https://raw.githubusercontent.com/zhenfeng-zhu/pic-go/main/202301072216928.png)

é€šè¿‡ http importï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªå°çš„å‡½æ•°ä¸­ï¼Œå‘æŒ¥æ›´å¤§çš„å¨åŠ›ï¼Œå¤§å±•å®å›¾ï¼Œä¸ç”¨åœ¨é™·å…¥
npm install å¸¦æ¥çš„ node_modules é»‘æ´ã€‚

# ä¸‹ä¸€ä»£ web æ¡†æ¶ fresh

Fresh ç”± Deno ä½œè€…å‡ºå“ï¼Œåœ¨æœ€è¿‘å‘å¸ƒäº† 1.0 çš„æ­£å¼ç‰ˆæœ¬ï¼Œå®£å¸ƒæ”¯æŒäº†ç”Ÿäº§ç¯å¢ƒï¼Œå¹¶ä¸”åœ¨
Github ä¸Šçƒ­åº¦ä¹Ÿæ¯”è¾ƒé«˜ã€‚

![](https://raw.githubusercontent.com/zhenfeng-zhu/pic-go/main/202301072216727.png)

é¦–å…ˆï¼ŒFresh åŸºäº Deno è¿è¡Œæ—¶ï¼Œç”± Deno åŸç­äººé©¬å¼€å‘ï¼Œäº«æœ‰ Deno
ä¸€ç³»åˆ—å·¥å…·é“¾å’Œç”Ÿæ€çš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚å†…ç½®çš„[æµ‹è¯•å·¥å…·](https://www.zhihu.com/search?q=%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A%222638750513%22%7D)ã€æ”¯æŒ
http import ç­‰ç­‰ã€‚

å…¶æ¬¡æ˜¯æ¸²æŸ“æ€§èƒ½æ–¹é¢ï¼ŒFresh æ•´ä½“é‡‡ç”¨ Islands æ¶æ„(ä¹‹å‰ä»‹ç»çš„ Astro
ä¹Ÿæ˜¯ç±»ä¼¼)ï¼Œå®ç°äº†å®¢æˆ·ç«¯æŒ‰éœ€ Hydrationï¼Œæœ‰ä¸€å®šçš„æ¸²æŸ“æ€§èƒ½ä¼˜åŠ¿ã€‚

å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå‡ºè‰²çš„ç‚¹æ˜¯æ„å»ºå±‚åšåˆ°äº†
Bundle-lessï¼Œå³åº”ç”¨ä»£ç ä¸éœ€è¦æ‰“åŒ…å³å¯ç›´æ¥éƒ¨ç½²ä¸Šçº¿ï¼Œåæ–‡ä¼šä»‹ç»è¿™éƒ¨åˆ†çš„å…·ä½“å®ç°ã€‚

# å‡½æ•°è¿è¡Œæ—¶

åœ¨é€‰å®šæŠ€æœ¯æ ˆä¹‹åï¼Œå°±å¼€å§‹å¹²æ´»ã€‚

## åŠ¨æ€å¯¼å…¥

ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå°±æ˜¯åŠ è½½ä¸€ä¸ªä»£ç ç‰‡æ®µæ‰§è¡Œå¹¶è·å–ç»“æœã€‚æœ‰ç‚¹å„¿ç±»ä¼¼åŠ¨æ€è¯­è¨€ä¸­çš„ eval
å‡½æ•°ã€‚

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ js ä¸­ï¼Œå¦‚æœè¦å¯¼å…¥ä¸€ä¸ªå‡½æ•°ï¼Œä¸€èˆ¬ç”¨ import è¯­å¥ã€‚æ¯”å¦‚ï¼š

```jsx
import { sayBye, sayHi } from "./say.js";
```

è¿™ç§å¯¼å…¥è¯­å¥ç§°ä¹‹ä¸ºâ€œé™æ€â€å¯¼å…¥ï¼Œè¯­æ³•éå¸¸ç®€å•ä¸”ä¸¥æ ¼ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ä¸èƒ½åŠ¨æ€ç”Ÿæˆ import
çš„ä»»ä½•å‚æ•°ï¼Œæ¨¡å—çš„è·¯å¾„ä¹Ÿå¿…é¡»æ˜¯åŸå§‹ç±»å‹çš„å­—ç¬¦ä¸²ï¼Œä¸èƒ½æ˜¯å‡½æ•°è°ƒç”¨ï¼Œç±»ä¼¼ä¸‹é¢çš„
import æ˜¯è¡Œä¸é€šçš„ï¼š

```jsx
import ... from getModuleName()
```

å…¶æ¬¡ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•æ ¹æ®æ¡ä»¶æˆ–è€…è¿è¡Œæ—¶å¯¼å…¥ï¼š

```jsx
if(...) {
	import ...
}else{
	import ...
}
```

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•æ‰èƒ½åŠ¨æ€çš„æŒ‰éœ€å¯¼å…¥æ¨¡å—å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ï¼Œå°±æœ‰ import()è¡¨è¾¾å¼ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­çš„ä»»æ„ä½ç½®åŠ¨æ€åœ°ä½¿ç”¨å®ƒã€‚ä¾‹å¦‚ï¼š

```ts
let modulePath = prompt("Which module to load?");

import(modulePath)
  .then(obj => <module object>)
  .catch(err => <loading error, e.g. if no such module>)
```

æˆ–è€…ï¼Œå¦‚æœåœ¨å¼‚æ­¥å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `let module = await import(modulePath)`ã€‚

æƒ…å†µä¼¼ä¹æ¯”è¾ƒæ˜æœ—ã€‚ä½†æ˜¯ï¼ŒåŠ¨æ€å¯¼å…¥ï¼Œåœ¨ deno deploy
æˆ–è€…è¯´åœ¨ä¸€äº›æœåŠ¡å™¨æ‰˜ç®¡çš„ç½‘ç«™æ˜¯ä¸æ”¯æŒçš„ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æœ‰æƒ³ä¸€äº›åŠæ³•å»é¿å…è¿™ä¸ªé—®é¢˜ã€‚

å¥½åœ¨ï¼Œè¿™äº›å‘å‰äººéƒ½è¸©åˆ°è¿‡ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç°æˆçš„ deno çš„æ”¯æŒï¼Œå®ƒå°±æ˜¯
[import](https://github.com/ayoreis/import) ã€‚

> A ponyfill for using dynamic imports in contexts without, like Deno Deploy ,
> Deno compiled executables and older browsers (see #4).

å®ƒæä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ importModule å’Œ importStringã€‚

```ts
import { importModule } from "https://deno.land/x/import/mod.ts";

if (Math.random() > 0.5) {
  await importModule("./foo.ts");
} else {
  await importModule("./bar.ts");
}
```

```ts
import { importString } from "https://deno.land/x/import/mod.ts";

console.log(await importString('export const foo = "bar"'));
```

å› æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ç§å½¢å¼åŠ è½½ä»£ç å¹¶æ‰§è¡Œã€‚

## åŠ¨æ€ API è·¯ç”±

åˆ©ç”¨ fresh æ¡†æ¶çš„åŠ¨æ€è·¯ç”±ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„æ„å»ºå‡½æ•° APIã€‚

![](https://raw.githubusercontent.com/zhenfeng-zhu/pic-go/main/202301081909263.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ`[name].ts` å°±æ˜¯åŠ¨æ€çš„ api è·¯ç”±ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°ä¸­è·å–åˆ° name å‚æ•°ã€‚

```ts
export const handler = async (
  _req: Request,
  _ctx: HandlerContext
): Promise<Response> => {
  const name = _ctx.params.name;

  if (_req.method !== "POST") {
    return Response.json({ error: "Only support post" });
  }

  const payload = await _req.json();
  return Response.json(result);
};
```

é€šè¿‡è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

1. åœ¨ fresh ä¸­ï¼Œå†™ä¸€ä¸ª api çš„ç‰¹åˆ«ç®€å•ï¼Œæ•´ä¸ªçš„æ ¼å¼å¦‚ä¸‹ï¼š

```ts
export const handler = async (
  _req: Request,
  _ctx: HandlerContext
): Promise<Response> => {
  return Response.json({ status: 200 });
};
```

2. è·å–åŠ¨æ€è·¯ç”±å‚æ•°ï¼Œç›´æ¥ä» ctx.params è·å–å³å¯ã€‚

3. ä» `_req.json()` å¯ä»¥è·å–åˆ° post è¯·æ±‚ä¸­çš„ bodyã€‚

# æ™ºèƒ½åˆçº¦

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†å‡½æ•°ä»£ç ç‰‡æ®µå­˜å‚¨åˆ°é“¾ä¸Šã€‚åœ¨ä»¥å¤ªåŠä¸Šï¼Œæ™ºèƒ½åˆçº¦çš„å¼€å‘ä¸€èˆ¬é€‰æ‹©
hardhatã€‚

## åˆçº¦å¼€å‘ç¯å¢ƒ

### Foundry

åœ¨ä»¥å¤ªåŠçš„æ™ºèƒ½åˆçº¦å¼€å‘ç¯å¢ƒä¸­ï¼Œå¦‚æœä½ æ˜¯ nodejs å¼€å‘è€…ï¼Œé‚£ä¹ˆä¸€å®šä¼šä¹ æƒ¯ hardhat
ä½“ç³»çš„å¼€å‘ï¼Œ foundry æ˜¯åèµ·ä¹‹ç§€ï¼Œå¦‚æœä½ æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æˆ–æœ‰è¿‡ç±»ä¼¼ä½“éªŒï¼Œä½ ä¸€å®šè¦è¯•è¯•
Foundryï¼š

- å¦‚æœä½ æœ‰ Rust â€œè¯­è¨€ä¿¡ä»°â€ï¼Œå¦‚æœä½ æ˜¯ä¸ªä¸“ä¸šçš„ ä»¥å¤ªåŠï¼ˆSolidity è¯­è¨€ï¼‰åº”ç”¨å¼€å‘è€…ï¼›
- ä½ æ›¾ç»ç”¨è¿‡ç±»ä¼¼ Hardhat.js è¿™æ ·çš„å·¥å…·ï¼›
- ä½ åŒå€¦äº†å¤§é‡æµ‹è¯•ç”¨ä¾‹çš„ç­‰å¾…ï¼Œéœ€è¦æœ‰å·¥å…·æ›´åŠ å¿«é€Ÿçš„è·‘å®Œä½ çš„æµ‹è¯•ç”¨ä¾‹ï¼›
- ä½ è§‰å¾—å¤„ç† BigNumber ç¨å¾®æœ‰ä¸€ç‚¹ç‚¹ ğŸ¤ éº»çƒ¦;
- æœ‰è¿‡é€šè¿‡ Solidity è¯­è¨€æœ¬èº«å®Œæˆæµ‹è¯•ç”¨ä¾‹ï¼ˆæˆ–æµ‹è¯•åˆçº¦çš„åˆçº¦ï¼‰çš„éœ€æ±‚ï¼›
- ä½ è§‰å¾—é€šè¿‡ git submodule çš„æ–¹å¼ç®¡ç†ä¾èµ–æ›´åŠ æ–¹ä¾¿ï¼ˆè€Œä¸æ˜¯ npmï¼‰ï¼›

è¿™æ¬¡ï¼Œç”±äºè¿™ä¸€æ¬¡çš„æ™ºèƒ½åˆçº¦å¹¶ä¸å¤æ‚ï¼Œç±»ä¼¼ä¸€ä¸ª ERC721 çš„ NFT åˆçº¦ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»£ç ç‰‡æ®µä¸Šä¼ åˆ°é“¾ä¸Šï¼Œæ‰€ä»¥é€‰æ‹©å°é²œä¸€ä¸‹ foundryã€‚

é¦–å…ˆæ˜¯ä¸‹è½½å®‰è£…ï¼š

```bash
$ curl -L https://foundry.paradigm.xyz | bash
```

ç„¶ååˆå§‹åŒ–é¡¹ç›®ï¼š

```bash
$ forge init faas3_contract
Initializing /Users/bytedance/github/faas3/faas3_contract...
Installing forge-std in "/Users/bytedance/github/faas3/faas3_contract/lib/forge-std" (url: Some("https://github.com/foundry-rs/forge-std"), tag: None)
    Installed forge-std v1.2.0
    Initialized forge project.
```

è¯¥è¿‡ç¨‹é€šè¿‡å®‰è£…ä¾èµ– forge-std åˆå§‹åŒ–äº†ä¸€ä¸ª Foundry é¡¹ç›®ã€‚

é¡¹ç›®çš„ç›®å½•å¦‚ä¸‹ï¼š

```bash
$ tree -L 2
.
â”œâ”€â”€ foundry.toml
â”œâ”€â”€ lib
â”‚Â Â  â””â”€â”€ forge-std
â”œâ”€â”€ script
â”‚Â Â  â””â”€â”€ Counter.s.sol
â”œâ”€â”€ src
â”‚Â Â  â””â”€â”€ Counter.sol
â””â”€â”€ test
    â””â”€â”€ Counter.t.sol

6 directories, 4 files
```
